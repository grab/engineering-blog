<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Dealing with the Meltdown patch at Grab</title>
    <meta name="description" content="The meltdown attack reported recently had far reaching implications in terms of security as well as performance. This post is a quick rundown of what performance impacts we noted as well as how we went on to mitigate them.">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Open Graph -->
    <meta property="og:url" content="https://engineering.grab.com/dealing-with-the-meltdown-patch-at-grab">
    <meta property="og:title" content="Dealing with the Meltdown patch at Grab">
    <meta property="og:description" content="The meltdown attack reported recently had far reaching implications in terms of security as well as performance. This post is a quick rundown of what performance impacts we noted as well as how we went on to mitigate them.">
    <meta property="og:site_name" content="Grab Tech">
    <meta property="og:type" content="article">
    <meta property="og:image" content="https://engineering.grab.com/img/dealing-with-the-meltdown-patch-at-grab/cover.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Favicons -->
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <!-- CSS -->
    <link href="//fonts.googleapis.com/css?family=Droid+Serif:400,400i,700,700i" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://engineering.grab.com/dealing-with-the-meltdown-patch-at-grab">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS for Official Grab Tech Blog" href="/feed.xml">
</head>

  <body>
    <header class="site-header">
  <div class="wrapper">
    <div class="site-title-wrapper">
      <div class="row site-title-wrapper-inner">
        <div class="col-sm-8 col-xs-4">
          <div>
            <a class="site-title" href="/"></a>
            <span class="site-subtitle hidden-xs">&nbsp;Tech Blog</span>
          </div>
        </div>
        <div class="col-sm-4 col-xs-8 text-right site-search">
          <form action="/search.html" method="get">
  <div class="input-group">
    <input type="text" id="search" name="q" class="form-control" placeholder="Search...">
    <span class="input-group-btn">
      <button class="btn" type="submit"><i class="fa fa-search"></i></button>
    </span>
  </div>
</form>

        </div>
      </div>
    </div>
    <nav>
      <ul class="nav-category">
        
          
          <li>
            <a href="/categories/engineering/">Engineering</a>
          </li>
        
          
          <li>
            <a href="/categories/data-science/">Data Science</a>
          </li>
        
          
          <li>
            <a href="/categories/design/">Design</a>
          </li>
        
          
          <li>
            <a href="/categories/product/">Product</a>
          </li>
        
      </ul>
    </nav>
  </div>
</header>

    <div class="page-content">
      
<div class="wrapper">
  <div class="post">
    <header class="post-header">
      <div class="text-center">
        
          
            
            
              <img class="post-author-thumbnail-large img-circle" src="/img/authors/althaf-hameez.jpg">
            
          
        
      </div>
      <br>
      <h1 class="post-title text-center">Dealing with the Meltdown patch at Grab</h1>
      <div class="post-meta">
        7 Jan 2018
        
          
            
            
              &middot;
              
                Althaf Hameez
              
            
          
        
        
        
          <div class="post-tags">
  
  
    <a href="/tags#aws" class="label tags-label">AWS</a>
  
    <a href="/tags#meltdown" class="label tags-label">Meltdown</a>
  
</div>

        
      </div>
    </header>
    <article class="post-content">
      <p>Grab is more than just the leading ride-hailing and mobile payments platform in Southeast Asia. We use data and technology to improve everything from transportation to payments across a region of more than 620 million people.</p>

<p>The <a href="http://meltdownattack.com/">meltdown attack</a> reported recently had far reaching implications in terms of security as well as performance. This post is a quick rundown of what performance impacts we noted as well as how we went on to mitigate them.</p>

<p>Most of our infrastructure runs on AWS. Initially, the only indicators we had were the slightly more than usual EC2 maintenance notices sent by AWS. However, as most of our EC2 fleet is stateless, we were able to simply terminate the required instances and spin up new ones. All the instances run on HVM across a variety of instance types running multiple Golang and Ruby applications and we didn’t notice any performance impact.</p>

<p>The one place where we did notice a performance impact was on Elasticache. We use Elasticache, the managed service offered by AWS, to run hundreds of Redis nodes. These Redis instances are used by services in multiple ways and we run both the clustered version as well as the non-clustered version.</p>

<p>On January 3rd, our automatic alerting triggered at around noon for high CPU utilization on one of our critical redis nodes. The CPU utilisation had jumped from around 36% to 76%. Now those numbers don’t look too bad until you realize that this is an m4.large instance which means it has 2 vCPUs. Combined with the fact that Redis is single-threaded, whenever we see CPU utilization go past 50% it’s a cause for concern.</p>

<p>The initial suspicions were a deployment / workload change causing the spike and our initial investigations focused on that. However, over the course of a few hours, multiple unrelated Redis nodes started displaying the exact same behaviour with sudden significant spikes in CPU utilisation.</p>

<div class="post-image-section">
  <img alt="Fig 1. Redis CPU Utilization" src="/img/dealing-with-the-meltdown-patch-at-grab/redis-cpu.png" />
  <small class="post-image-caption">Fig 1. Redis CPU Utilization</small>
</div>

<p>Notice the multiple sudden steep spikes in CPU utilisation and then plateauing as time goes on.</p>

<p>Some of the Redis with CPU utilisation spikes were the replica nodes in the multi-az setup. As most services were having these replicas purely for HA and not actively using them, having the CPU utilization on it spike without the master node spiking indicated that it was no longer a workload issue. At this point, we escalated to AWS with the data in hand.</p>

<p>Later that night, we then attempted to perform <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/UserGuide/AutoFailover.html">Multi-AZ Failovers for certain nodes </a> where the master had exhibited a spike but the replica hadn’t. Our suspicions at this time was that there was some underlying hardware issue and failing over to a node that wasn’t affected would help us. It was successful as once the replica became the master the CPU utilization went down to the original levels. We performed this operation for multiple nodes and then called it a night confident we’ve mitigated the problem.</p>

<p>Alas, our success was short-lived as the example graph below shows.</p>

<div class="post-image-section">
  <img alt="Fig 2. CPU Utilization of an affected Redis instance" src="/img/dealing-with-the-meltdown-patch-at-grab/sextant-cpu.png" />
  <small class="post-image-caption">Fig 2. CPU Utilization of an affected Redis instance</small>
</div>

<p>Initially, prd-sextant-001 was the master and 002 was the replica. At noon on the 3rd, you see the CPU spike on master, the corresponding drop on the replica is still unexplained (The hypothesis is that a percentage of updates failed on the master node resulting in a smaller set of changes to be replicated). Early in the morning on the 4th is when we performed the failover, you see 002 now having utilization equal to 001. On the evening of the 4th, however, you see 002 have it’s CPU utilization significantly spike up.</p>

<p>With <a href="https://aws.amazon.com/security/security-bulletins/AWS-2018-013/">information released from AWS</a> that the EC2 maintenance was related to meltdown and <a href="https://www.phoronix.com/scan.php?page=article&amp;item=linux-415-x86pti&amp;num=1">benchmarks</a> being released about the performance impact of the patches, the two were put together as the possible explanation of what we were seeing. AWS could be performing rolling patches to the Elasticache nodes. As a node gets patched the CPU spikes and our failovers were only successful in reducing the utilization because we were failing over to a node that wasn’t yet patched. However, once that node got patched the CPU would spike again.</p>

<p>Realizing that this was now going to be the expected performance the teams quickly sprung into action on how to best spread the load.</p>

<p><strong>Clustered Redis</strong></p>

<p>We would add additional shards so that the load gets spread evenly. This was complicated by the fact that we were running on the engine version 3.2.4 which didn’t support live re-sharding so we had to spin up a lot of new clusters with the additional shards, ensure that the cache gets warmed up before switching completely over and decommissioning the old one.</p>

<div class="post-image-section">
  <img alt="Fig 3. Old API Redis Cluster with nodes going up to 50% peak CPU" src="/img/dealing-with-the-meltdown-patch-at-grab/grab-api-cpu.png" />
  <small class="post-image-caption">Fig 3. Old API Redis Cluster with nodes going up to 50% peak CPU</small>
</div>

<div class="post-image-section">
  <img alt="Fig 4. New API Redis Cluster with additional shards now hovering at about 30% peak CPU" src="/img/dealing-with-the-meltdown-patch-at-grab/grab-api-cpu-2.png" />
  <small class="post-image-caption">Fig 4. New API Redis Cluster with additional shards now hovering at about 30% peak CPU</small>
</div>

<div class="post-image-section">
  <img alt="Fig 5. Old Hot Data Redis Cluster with CPU peaking at around 48%" src="/img/dealing-with-the-meltdown-patch-at-grab/hot-data-cpu.png" />
  <small class="post-image-caption">Fig 5. Old Hot Data Redis Cluster with CPU peaking at around 48%</small>
</div>

<div class="post-image-section">
  <img alt="Fig 6. New Hot Data Redis Cluster with CPU peaking at around 24%" src="/img/dealing-with-the-meltdown-patch-at-grab/hot-data-cpu-2.png" />
  <small class="post-image-caption">Fig 6. New Hot Data Redis Cluster with CPU peaking at around 24%</small>
</div>

<p><strong>Non-Clustered Redis</strong></p>

<ul>
  <li>
    <p>Some of our systems were already designed to use multiple Redis nodes. So provisioning additional nodes and updating the configs to start using these nodes was the easiest solution.</p>
  </li>
  <li>
    <p>For certain Redis nodes that were able to utilize Redis Cluster with minimal code change, we switched them to use Redis Cluster.</p>
  </li>
  <li>
    <p>The final few Redis nodes, the service teams made significant code changes so that they could shard the data onto multiple nodes.</p>
  </li>
</ul>

<div class="post-image-section">
  <img alt="Fig 7. Redis where code changes were made to shard the data across multiple nodes to reduce the overall load on a single critical node" src="/img/dealing-with-the-meltdown-patch-at-grab/web-cache.png" />
  <small class="post-image-caption">Fig 7. Redis where code changes were made to shard the data across multiple nodes to reduce the overall load on a single critical node</small>
</div>

<p>All of these mitigations were done over a period of 24 hours to ensure that we go past our Friday peak (our highest traffic point during the week) without any customer facing impact.</p>

<p><strong>Conclusion</strong></p>

<p>This post was meant to give a quick glimpse of the impact that Meltdown has had at Grab as well provide some real data on the performance impact of the patches.</p>

<p>The design of our internal systems in their usage of Redis to quickly be able to horizontally scale-out was key in ensuring that there was minimal impact, if any to our customers.</p>

<p>We still have further investigation to conduct to truly understand why only certain Redis workloads were affected while others weren’t. We are planning to dive deeper into this and that may be the subject of a future blog post.</p>


    </article>
    <div>
      
        <div class="post-tags">
  
  
    <a href="/tags#aws" class="label tags-label">AWS</a>
  
    <a href="/tags#meltdown" class="label tags-label">Meltdown</a>
  
</div>

      
      <br>
    </div>
    <div class="sharing-links text-right">
  Share on &nbsp;
  <a href="https://twitter.com/intent/tweet?text=Dealing with the Meltdown patch at Grab&url=https://engineering.grab.com/dealing-with-the-meltdown-patch-at-grab&via=grabengineering&related=grabengineering" class="btn btn-sm btn-share btn-share-twitter" rel="nofollow" target="_new" title="Share on Twitter" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-twitter"></i>&nbsp; Twitter</a>
  <a href="https://facebook.com/sharer.php?u=https://engineering.grab.com/dealing-with-the-meltdown-patch-at-grab" class="btn btn-sm btn-share btn-share-facebook" rel="nofollow" target="_new" title="Share on Facebook" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-facebook"></i>&nbsp; Facebook</a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://engineering.grab.com/dealing-with-the-meltdown-patch-at-grab&title=Dealing with the Meltdown patch at Grab
&summary=The meltdown attack reported recently had far reaching implications in terms of security as well as performance. This post is a quick rundown of what performance impacts we noted as well as how we went on to mitigate them.&source=Grab Tech" class="btn btn-sm btn-share btn-share-linkedin" rel="nofollow" target="_new" title="Share on LinkedIn" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-linkedin"></i>&nbsp; LinkedIn</a>
</div>
<script>
  function onShareButtonClick(button) {
    var width = 600;
    var height = 600;
    var left = (window.screen.width / 2) - (width / 2);
    var top = (window.screen.height / 2) - (height / 2);
    window.open(button.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=' + height + ',width=' + width + ',top=' + top + ',left=' + left);
    return false;
  }
</script>

    <hr class="section-divider">
    <div class="panel panel-default hiring-panel">
      <div class="panel-body">
        <div class="row">
          <div class="col-sm-6">
            <h4 class="hiring-tagline">Want to work with us? Grab is hiring!</h4>
          </div>
          <div class="col-sm-6 hiring-btn-container">
            <a class="btn" href="https://grab.careers" target="_blank">View open positions</a>

          </div>
        </div>
      </div>
    </div>
    <br/>
    
      <div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = 'https://engineering.grab.com/dealing-with-the-meltdown-patch-at-grab';
    this.page.identifier = '/dealing-with-the-meltdown-patch-at-grab';
  };
  (function() {
    var d = document, s = d.createElement('script');
    s.src = '//grabengineering.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    
  </div>
</div>

    </div>
    <footer class="site-footer">
  <div class="wrapper">
    <div class="row">
      <div class="col-sm-6">
        <h2 class="footer-heading">Grab Tech</h2>
        <ul class="social-media-list">
  
    <li>
      <a href="https://github.com/grab" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-github fa-lg"></i>
      </a>
    </li>
  
  
    <li>
      <a href="https://facebook.com/grabengineering" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-facebook-square fa-lg"></i>
      </a>
    </li>
  
  
    <li>
      <a href="https://twitter.com/grabengineering" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-twitter fa-lg"></i>
      </a>
    </li>
  
  
    <li>
      <a href="https://www.linkedin.com/company-beta/5382086" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-linkedin fa-lg"></i>
      </a>
    </li>
  
  <li>
    <a href="https://engineering.grab.com/feed.xml" target="_blank">
      <i class="fa fa-rss fa-lg"></i>
    </a>
  </li>
</ul>

        <script src="//platform.linkedin.com/in.js" type="text/javascript"> lang: en_US</script>
        <script type="IN/FollowCompany" data-id="5382086" data-counter="right"></script>
      </div>
      <div class="col-sm-6 hiring-section">
        <h2 class="footer-heading">Join Us</h2>
        <p class="text">
          Want to join us in our mission to revolutionize transportation?
        </p>
        <a class="btn" href="https://grab.careers" target="_blank">View open positions</a>

      </div>
    </div>
  </div>
</footer>

    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-73060858-2', 'auto');
    ga('send', 'pageview');
  </script>


  </body>
</html>
