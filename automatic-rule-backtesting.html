<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Automatic rule backtesting with large quantities of data</title>
    <meta name="description" content="At Grab, real-time fraud detection is built on a rule engine. As data scientists and analysts, we need to analyse and simulate a rule on historical data to check the performance and accuracy of the rule. Backtesting, also known as Replay, enables analysts to run simulations of either newly-invented rules, or evaluate the performance of existing rules using past events ranging from days to months, and significantly improve rule creation efficiency.">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Open Graph -->
    <meta property="og:url" content="https://engineering.grab.com/automatic-rule-backtesting">
    <meta property="og:title" content="Automatic rule backtesting with large quantities of data">
    <meta property="og:description" content="At Grab, real-time fraud detection is built on a rule engine. As data scientists and analysts, we need to analyse and simulate a rule on historical data to check the performance and accuracy of the rule. Backtesting, also known as Replay, enables analysts to run simulations of either newly-invented rules, or evaluate the performance of existing rules using past events ranging from days to months, and significantly improve rule creation efficiency.">
    <meta property="og:site_name" content="Grab Tech">
    <meta property="og:type" content="article">
    <meta property="og:image" content="https://engineering.grab.com/img/auto-rule-testing/cover.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Favicons -->
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <!-- CSS -->
    <link href="//fonts.googleapis.com/css?family=Droid+Serif:400,400i,700,700i" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://engineering.grab.com/automatic-rule-backtesting">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS for Official Grab Tech Blog" href="/feed.xml">
</head>

  <body>
    <header class="site-header">
  <div class="wrapper-navbar">
    <div class="site-title-wrapper">
      <div class="row site-title-wrapper-inner">
        <div class="col-xs-1 visible-xs hamburger-nav" id="mobile-menu-btn">
          <div class="menu-btn"></div>
        </div>
        <div class="col-sm-3 col-xs-3">
          <div class="site-title-container">
            <a class="site-title" href="/"></a>
            <span class="site-subtitle">&nbsp;Tech Blog</span>
          </div>
        </div>
        <div class="col-sm-9 col-xs-8 text-right">
          <ul class="nav-category hidden-xs">
            
              
              <li>
                <a href="/categories/engineering/">Engineering</a>
              </li>
            
              
              <li>
                <a href="/categories/data-science/">Data Science</a>
              </li>
            
              
              <li>
                <a href="/categories/design/">Design</a>
              </li>
            
              
              <li>
                <a href="/categories/product/">Product</a>
              </li>
            
              
              <li>
                <a href="/categories/security/">Security</a>
              </li>
            
          </ul>
          <div class="site-search text-right">
            <form action="/search.html" role="search" class="search-form">
  <div class="search-icon"> </div>
  <input type="search" name="q" class="search-text" placeholder="Search...">
  <button class="search-submit"><i class="fa fa-chevron-right"></i></button>
</form>
    

          </div>
        </div>
      </div>
      <!--  Only visible on mobile view -->
      <div class="mobile-menu-container">
        <ul class="mobile-menu">
          
            
            <li>
              <a href="/categories/engineering/">Engineering</a>
            </li>
          
            
            <li>
              <a href="/categories/data-science/">Data Science</a>
            </li>
          
            
            <li>
              <a href="/categories/design/">Design</a>
            </li>
          
            
            <li>
              <a href="/categories/product/">Product</a>
            </li>
          
            
            <li>
              <a href="/categories/security/">Security</a>
            </li>
          
        </ul>
      </div>
    </div>
  </div>
</header>
<script src="/js/main.js"></script>

    <div class="page-content">
      
<div class="wrapper">
  <div class="post">
    <header class="post-header">
      <img src="/img/auto-rule-testing/cover.jpg" class="post-cover-photo" alt="Automatic rule backtesting with large quantities of data cover photo">
      
        
          <a class="post-category" href="/categories/engineering/">Engineering </a>
      
        
          &middot;
        
          <a class="post-category" href="/categories/data-science/">Data Science </a>
      

      <h1 class="post-title">Automatic rule backtesting with large quantities of data</h1>
      
      <div class="post-meta">
        <div class="row">
          <div class="col-xs-12">
            <div class="post-author-thumbnail-container">
              
                
                
                  <img class="post-author-thumbnail-large img-circle" src="/img/authors/chao-wang.jpg">
                
              
                
                
                  <img class="post-author-thumbnail-large img-circle" src="/img/authors/clemens-valiente.png">
                
              
                
                
                  <img class="post-author-thumbnail-large img-circle" src="/img/authors/jun-liu.jpg">
                
              
                
                
                  <img class="post-author-thumbnail-large img-circle" src="/img/authors/daniel-wang.JPG">
                
              
            </div>

            <div class="post-meta-text-container">
              <span class="post-author-large">
                
                  
                  
                    
                    <a href="/authors#chao-wang">Chao Wang</a>
                  
                
                  
                  
                    
                      &middot;
                    
                    <a href="/authors#clemens-valiente">Clemens Valiente</a>
                  
                
                  
                  
                    
                      &middot;
                    
                    <a href="/authors#jun-liu">Jun Liu</a>
                  
                
                  
                  
                    
                      &middot;
                    
                    <a href="/authors#daniel-wang">Daniel Wang</a>
                  
                
              </span>
              <span class="post-date-large">8 Sep 2022 | 6 min read</span>
            </div>
          </div>
        </div>
      </div>

    </header>
    <div class="wrapper-content">
      <article class="post-content">
        <h2 id="introduction">Introduction</h2>

<p>Analysts need to analyse and simulate a rule on historical data to check the performance and accuracy of the rule. Backtesting enables analysts to run simulations of the rules and manage the results from the rule engine UI.</p>

<p><strong>Backtesting</strong> helps analysts to:</p>

<ul>
  <li>Define the desired impact of the rule for our business and users.</li>
  <li>Evaluate the accuracy of the rule based on historical data.</li>
  <li>Compare and analyse results with data points, such as known false positives, user segments, risk profile of a user or transaction, and so on.</li>
</ul>

<p>Currently, the analytics process to test performance of a rule is not standardised, and is inaccurate and inefficient. Analysts from different teams have different approaches:</p>

<ul>
  <li>Offline process using Presto tables. This process is lengthy and inaccurate.</li>
  <li>Offline process based on the rule engine payload. The setup takes time, and the process is not streamlined.</li>
  <li>Running rules in shadow mode. This process takes days to get the desired result.</li>
  <li>A team in Grab uses different rule engines to manage rules and do backtesting. This doubles the effort for analysts and engineers.</li>
</ul>

<p>In our vision for backtesting, it should allow analysts to:</p>

<ul>
  <li>Efficiently run and manage their jobs.</li>
  <li>Create custom metrics, reports and dimensions for backtesting.</li>
  <li>Add external data points and metrics to do a deep dive.</li>
</ul>

<p>For the purpose of establishing a minimum viable product (MVP), backtesting will support basic capabilities and enable analysts to access required metrics and data points. Thus, analysts can:</p>

<ul>
  <li>Run backtesting jobs from the rule engine UI.</li>
  <li>Get fixed reports and dimensions for every checkpoint.</li>
  <li>Get access to relevant data to analyse backtesting results.</li>
</ul>

<h2 id="background">Background</h2>

<p>Assume a simple use case: <strong>A rule to detect the transaction risk.</strong> </p>

<p>Each transaction has a <code class="language-plaintext highlighter-rouge">transaction_id</code>, <code class="language-plaintext highlighter-rouge">user_id</code>, <code class="language-plaintext highlighter-rouge">currency</code>, <code class="language-plaintext highlighter-rouge">amount</code>, <code class="language-plaintext highlighter-rouge">timestamp</code>. The rule engine also provides a <em><code class="language-plaintext highlighter-rouge">treatment</code></em> (<code class="language-plaintext highlighter-rouge">Approve</code> or <code class="language-plaintext highlighter-rouge">Decline</code>) based on the rule logic for the transaction.</p>

<p>In this specific use case, we would like to see what will be the aggregation number of the <code class="language-plaintext highlighter-rouge">total transactions</code>, <code class="language-plaintext highlighter-rouge">total distinct users</code>, and the <code class="language-plaintext highlighter-rouge">sum of the amount</code>, based on the dimensions of <code class="language-plaintext highlighter-rouge">date</code>, <code class="language-plaintext highlighter-rouge">treatment</code>, <code class="language-plaintext highlighter-rouge">and currency</code> in the last couple of weeks.</p>

<p>The result may look like the following data:</p>

<table>
  <thead>
    <tr>
      <th>Dimension    </th>
      <th>Dimension    </th>
      <th>Dimension    </th>
      <th>metric      </th>
      <th>metric          </th>
      <th>metric     </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Date</td>
      <td>Treatment</td>
      <td>Currency</td>
      <td>Total tx</td>
      <td>Distinct user    </td>
      <td>Total amount</td>
    </tr>
    <tr>
      <td>2020-05-1</td>
      <td>Approve</td>
      <td>SGD</td>
      <td>100</td>
      <td>80</td>
      <td>10020</td>
    </tr>
    <tr>
      <td>2020-05-1</td>
      <td>Decline</td>
      <td>SGD</td>
      <td>50</td>
      <td>40</td>
      <td>450</td>
    </tr>
    <tr>
      <td>2020-05-1</td>
      <td>Approve</td>
      <td>MYR</td>
      <td>110</td>
      <td>100</td>
      <td>1200</td>
    </tr>
    <tr>
      <td>2020-05-1</td>
      <td>Decline</td>
      <td>MYR</td>
      <td>30</td>
      <td>15</td>
      <td>400</td>
    </tr>
  </tbody>
</table>

<p>* This data does not reflect actual Grab data and is for illustrative purposes only.</p>

<h2 id="solution">Solution</h2>

<ul>
  <li>Use a cloud-agnostic Spark-based data pipeline to replay any existing or proposed rule to check performance.</li>
  <li>Use a Web Portal to:
    <ul>
      <li>Create or select a rule to replay, with replay time range.</li>
      <li>Display and download the result, such as total events and hit counts.</li>
    </ul>
  </li>
  <li>Replay any existing or proposed rule for checking performance.</li>
  <li>Allow users to create or select a rule to replay in the rule engine UI, with provided replay time range.</li>
  <li>Display the replay result in the rule engine UI, such as total events and hit counts.</li>
  <li>Provide a way to download all testing results in the rule engine UI (for example, all rule responses).</li>
  <li>Remove dependency on the specific cloud provider stack, so other teams in Grab can use it instead of Google Cloud Platform (GCP).</li>
</ul>

<h3 id="architecture-details">Architecture details</h3>

<div class="post-image-section"><figure>
  <img src="/img/auto-rule-testing/image2.png" alt="" style="width:80%" /><figcaption align="middle"></figcaption>
  </figure>
</div>

<p>The rule editor UI reacts to the user input. Its engine sends a job command to the Amazon Simple Queue Service (SQS) to initialise the job. After that, the rule editor also performs the following processes in the background:</p>

<ul>
  <li>Lambda listens to the request SQS queue and invokes a job via the Spark jobs API.</li>
  <li>The job fetches the executable artifacts, data source. After the job is completed, the job script saves the result sheet as required to S3.</li>
  <li>The Spark script pushes the job final status (success, failure, timeout) through the shutdown hook to respond to the SQS queue.</li>
  <li>The rule editor engine listens to response callback messages, and processes the job metadata to the database, or sends notifications.</li>
  <li>The rule editor displays the job metadata on the UI.</li>
  <li>The package pipeline builds and deploys the executable artifacts to S3 as a manageable structure.</li>
  <li>The Spark script takes the filter logic as its input parameters.</li>
</ul>

<h3 id="workflow">Workflow</h3>

<h4 id="historical-data-preparation">Historical data preparation</h4>

<p>The historical events are published by the rule engine through Kafka, and stored into the S3 bucket based on time. The Backtesting system then fetches these data for testing based on the time range requested.</p>

<p>By using a Kubernetes stream pipeline, we also save the trust inference stream to <em>Trust AWS subaccount</em>. With the customer bucket and file format, we can improve the efficiency of the data processing, and also avoid any delay from the data lake.</p>

<h4 id="engineering-specifications">Engineering specifications</h4>

<ul>
  <li>Target location:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    s3a://stg-trust-inference-event/&lt;engine-name&gt;/&lt;predict-name&gt;/&lt;YYYY&gt;/MM/DD/hh/mm/ss/&lt;000001&gt;.snappy.parquet
    s3a://prd-trust-inference-event/&lt;engine-name&gt;/&lt;predict-name&gt;/&lt;YYYY&gt;/MM/DD/hh/mm/ss/&lt;000001&gt;.snappy.parquet
</code></pre></div></div>

<p><strong>Description</strong>: Following the fields of steam definition, the engine name would be <code class="language-plaintext highlighter-rouge">ruleengine</code>, or <code class="language-plaintext highlighter-rouge">catwalk</code>. The predict-name would be <code class="language-plaintext highlighter-rouge">preride</code> (checkpoint name), or <code class="language-plaintext highlighter-rouge">cnpu</code> (model name).</p>

<ul>
  <li>File Format: avro</li>
  <li>File Compression: Snappy</li>
  <li>There is no auto retention on sub-account S3. We will implement the archive process in the future. </li>
  <li>The default pipeline and the new pipeline will run in parallel until the Data Engineering team is ready to retire the default pipeline.</li>
</ul>

<h4 id="backtesting">Backtesting</h4>

<ul>
  <li>Upon scheduling, the Backtesting Portal sends a message to SQS, which is then captured by the listening Lambda.</li>
  <li>Lambda invokes a Spark job over the AWS elastic mapreduce engine (EMR).</li>
  <li>The EMR engine fetches the executable artifacts containing the rule script and historical data from S3, and starts a Spark job to apply the rule script over historical data. Depending on the size of data, the Spark cluster will scale automatically to ensure timely completion.</li>
  <li>Once completed, a report file is generated and available on Backtesting UI.</li>
</ul>

<h3 id="ui">UI</h3>

<div class="post-image-section"><figure>
  <img src="/img/auto-rule-testing/image1.gif" alt="" style="width:80%" /><figcaption align="middle"></figcaption>
  </figure>
</div>

<h2 id="learnings-and-conclusions">Learnings and conclusions</h2>

<p>After the release, here’s what our data analysers had to say:</p>

<ul>
  <li>For trust analysts, testing a rule on historical data happens outside the rule engine UI and is not user-friendly, leading to analysts wasting significant time.</li>
  <li>For financial analysts, as analysts migrate to the rule engine UI, the existing solution will be deprecated with no other solution.</li>
  <li>An alternative to simulate a rule;  we no longer need to run a rule in shadow mode because we can use historical data to determine the outcome. This new approach saves us weeks of effort on the rule onboarding process.</li>
</ul>

<h2 id="whats-next">What’s next?</h2>

<p>The underlying Spark jobs in this tool were developed by knowledgeable data engineers, which is a disadvantage because it requires a high level of expertise to modify the analytics. To mitigate this restriction, we are looking into using domain-specific language (DSL) to allow users to input desired attributes and dimensions, and provide the job release pipeline for self-serving jobs.</p>

<hr />

<p><small class="credits">Thanks to Jia Long Loh for the support on the offline infrastructure engineering.</small></p>

<h1 id="join-us">Join us</h1>
<p>Grab is the leading superapp platform in Southeast Asia, providing everyday services that matter to consumers. More than just a ride-hailing and food delivery app, Grab offers a wide range of on-demand services in the region, including mobility, food, package and grocery delivery services, mobile payments, and financial services across 428 cities in eight countries.</p>

<p>Powered by technology and driven by heart, our mission is to drive Southeast Asia forward by creating economic empowerment for everyone. If this mission speaks to you, <a href="https://grab.careers/">join our team</a> today!</p>

      </article>
      <div>
        
          <div class="post-tags">
  
  
    <a href="/tags#automation" class="label tags-label">Automation</a>
  
    <a href="/tags#backtesting" class="label tags-label">Backtesting</a>
  
    <a href="/tags#data-science" class="label tags-label">Data science</a>
  
    <a href="/tags#testing" class="label tags-label">Testing</a>
  
</div>

        
        <br>
      </div>
      <div class="sharing-links text-right">
  Share on &nbsp;
  <a href="https://twitter.com/intent/tweet?text=Automatic rule backtesting with large quantities of data&url=https://engineering.grab.com/automatic-rule-backtesting&via=grabengineering&related=grabengineering" class="btn btn-sm btn-share btn-share-twitter" rel="nofollow" target="_new" title="Share on Twitter" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-twitter"></i>&nbsp; Twitter</a>
  <a href="https://facebook.com/sharer.php?u=https://engineering.grab.com/automatic-rule-backtesting" class="btn btn-sm btn-share btn-share-facebook" rel="nofollow" target="_new" title="Share on Facebook" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-facebook"></i>&nbsp; Facebook</a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://engineering.grab.com/automatic-rule-backtesting&title=Automatic rule backtesting with large quantities of data
&summary=At Grab, real-time fraud detection is built on a rule engine. As data scientists and analysts, we need to analyse and simulate a rule on historical data to check the performance and accuracy of the rule. Backtesting, also known as Replay, enables analysts to run simulations of either newly-invented rules, or evaluate the performance of existing rules using past events ranging from days to months, and significantly improve rule creation efficiency.&source=Grab Tech" class="btn btn-sm btn-share btn-share-linkedin" rel="nofollow" target="_new" title="Share on LinkedIn" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-linkedin"></i>&nbsp; LinkedIn</a>
</div>
<script>
  function onShareButtonClick(button) {
    var width = 600;
    var height = 600;
    var left = (window.screen.width / 2) - (width / 2);
    var top = (window.screen.height / 2) - (height / 2);
    window.open(button.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=' + height + ',width=' + width + ',top=' + top + ',left=' + left);
    return false;
  }
</script>

      <hr class="section-divider">

      <br/>
      <!-- 
        <div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = 'https://engineering.grab.com/automatic-rule-backtesting';
    this.page.identifier = '/automatic-rule-backtesting';
  };
  (function() {
    var d = document, s = d.createElement('script');
    s.src = '//grabengineering.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

       -->

    </div>
  </div>
</div>

    </div>
    <div class="progress-wrap">
    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98" />
    </svg>
    <i class="fa fa-chevron-up btt-btn"></i>
</div>
    <footer class="site-footer">
  <div class="wrapper">
    <div class="row">
      <div class="col-sm-6 col-xs-12">
        <h2 class="footer-heading">Grab Tech</h2>
        <ul class="social-media-list">
  
    <li>
      <a href="https://github.com/grab" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-github fa-lg"></i>
      </a>
    </li>
  
  
    <li>
      <a href="https://www.linkedin.com/company/grabapp" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-linkedin fa-lg"></i>
      </a>
    </li>
  
  <li>
    <a href="https://engineering.grab.com/feed.xml" target="_blank">
      <i class="fa fa-rss fa-lg"></i>
    </a>
  </li>
</ul>

        <div>
          <script src="//platform.linkedin.com/in.js" type="text/javascript"> lang: en_US</script>
          <script type="IN/FollowCompany" data-id="5382086" data-counter="right"></script>
        </div>        
        <br>
      </div>
      <div class="col-sm-6 col-xs-12 hiring-section">
        <h2 class="footer-heading">Join Us</h2>
        <p class="text">
          Want to join us in our mission to revolutionize transportation?
        </p>
        <a class="btn" href="https://grab.careers" target="_blank">View open positions</a>

      </div>
    </div>
    
  <!-- Google Tag Manager -->
  <script>
    (function (w, d, s, l, i) {
      w[l] = w[l] || [];
      w[l].push({
        'gtm.start': new Date().getTime(),
        event: 'gtm.js'
      });
      var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != 'dataLayer' ? '&l=' + l : '';
      j.async = true;
      j.src =
        'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
      f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-T3CT72T');
  </script>
  <!-- End Google Tag Manager -->

  <!-- Old script 
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'GTM-T3CT72T', 'auto');
    ga('send', 'pageview');
  </script> -->
<!-- End of olf script -->


  </body>
</html>
