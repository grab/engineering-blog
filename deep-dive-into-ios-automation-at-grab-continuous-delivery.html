<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Deep Dive into iOS Automation at Grab - Continuous Delivery</title>
    <meta name="description" content="This is the second part of our series "Deep Dive into iOS Automation at Grab", where we will cover how we manage continuous delivery. As a common solution to Apple developer account device whitelist limitation, we use an enterprise account to distribute beta apps internally. There are 4 build configurations per target.">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Open Graph -->
    <meta property="og:url" content="https://engineering.grab.com/deep-dive-into-ios-automation-at-grab-continuous-delivery">
    <meta property="og:title" content="Deep Dive into iOS Automation at Grab - Continuous Delivery">
    <meta property="og:description" content="This is the second part of our series "Deep Dive into iOS Automation at Grab", where we will cover how we manage continuous delivery. As a common solution to Apple developer account device whitelist limitation, we use an enterprise account to distribute beta apps internally. There are 4 build configurations per target.">
    <meta property="og:site_name" content="Grab Tech">
    <meta property="og:type" content="article">
    <meta property="og:image" content="https://engineering.grab.com/img/ios-automation/corgi-macbook.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Favicons -->
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <!-- CSS -->
    <link href="//fonts.googleapis.com/css?family=Droid+Serif:400,400i,700,700i" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://engineering.grab.com/deep-dive-into-ios-automation-at-grab-continuous-delivery">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS for Official Grab Tech Blog" href="/feed.xml">
</head>

  <body>
    <header class="site-header">
  <div class="wrapper-navbar">
    <div class="site-title-wrapper">
      <div class="row site-title-wrapper-inner">
        <div class="col-xs-1 visible-xs hamburger-nav" id="mobile-menu-btn">
          <div class="menu-btn"></div>
        </div>
        <div class="col-sm-3 col-xs-3">
          <div class="site-title-container">
            <a class="site-title" href="/"></a>
            <span class="site-subtitle">&nbsp;Tech Blog</span>
          </div>
        </div>
        <div class="col-sm-9 col-xs-8 text-right">
          <ul class="nav-category hidden-xs">
            
              
              <li>
                <a href="/categories/engineering/">Engineering</a>
              </li>
            
              
              <li>
                <a href="/categories/data-science/">Data Science</a>
              </li>
            
              
              <li>
                <a href="/categories/design/">Design</a>
              </li>
            
              
              <li>
                <a href="/categories/product/">Product</a>
              </li>
            
              
              <li>
                <a href="/categories/security/">Security</a>
              </li>
            
          </ul>
          <div class="site-search text-right">
            <form action="/search.html" role="search" class="search-form">
  <div class="search-icon"> </div>
  <input type="search" name="q" class="search-text" placeholder="Search...">
  <button class="search-submit"><i class="fa fa-chevron-right"></i></button>
</form>
    

          </div>
        </div>
      </div>
      <!--  Only visible on mobile view -->
      <div class="mobile-menu-container">
        <ul class="mobile-menu">
          
            
            <li>
              <a href="/categories/engineering/">Engineering</a>
            </li>
          
            
            <li>
              <a href="/categories/data-science/">Data Science</a>
            </li>
          
            
            <li>
              <a href="/categories/design/">Design</a>
            </li>
          
            
            <li>
              <a href="/categories/product/">Product</a>
            </li>
          
            
            <li>
              <a href="/categories/security/">Security</a>
            </li>
          
        </ul>
      </div>
    </div>
  </div>
</header>
<script src="/js/main.js"></script>

    <div class="page-content">
      
<div class="wrapper">
  <div class="post">
    <header class="post-header">
      <img src="/img/ios-automation/corgi-macbook.jpg" class="post-cover-photo" alt="Deep Dive into iOS Automation at Grab - Continuous Delivery cover photo">
      
        
          <a class="post-category" href="/categories/engineering/">Engineering </a>
      

      <h1 class="post-title">Deep Dive into iOS Automation at Grab - Continuous Delivery</h1>
      
      <div class="post-meta">
        <div class="row">
          <div class="col-xs-12">
            <div class="post-author-thumbnail-container">
              
                
                
                  <img class="post-author-thumbnail-large img-circle" src="/img/authors/sun-xiangxin.jpg">
                
              
                
                
                  <img class="post-author-thumbnail-large img-circle" src="/img/authors/paul-meng.jpg">
                
              
            </div>

            <div class="post-meta-text-container">
              <span class="post-author-large">
                
                  
                  
                    
                    <a href="/authors#sun-xiangxin">Sun Xiangxin</a>
                  
                
                  
                  
                    
                      &middot;
                    
                    <a href="/authors#paul-meng">Paul Meng</a>
                  
                
              </span>
              <span class="post-date-large">23 Apr 2017 | 5 min read</span>
            </div>
          </div>
        </div>
      </div>

    </header>
    <div class="wrapper-content">
      <article class="post-content">
        <p>This is the second part of our series ‚ÄúDeep Dive into iOS Automation at Grab‚Äù, where we will cover how we manage continuous delivery. The first article is available <a href="/deep-dive-into-ios-automation-at-grab-integration-testing">here</a>.</p>

<p>As a common solution to the limitations of an Apple developer account‚Äôs device whitelist, we use an enterprise account to distribute beta apps internally. There are 4 build configurations per target:</p>

<p><strong>Adhoc QA -</strong> Most frequently distributed builds for mobile devs and QAs whose devices present in the ad hoc provisioning profile.</p>

<p><strong>Hot Dogfood -</strong> Similar to adhoc QA (both have debug options to connect to a staging environment) but signed under an enterprise account. This build is meant for backend devs to test out their APIs on staging.</p>

<p><strong>Dogfood -</strong> Company-wide beta testing that includes both the online and offline team. This is often released when new features are ready or accepted by QA. It can also be a release candidate before we submit to the App Store.</p>

<p><strong>Testflight -</strong> Production regression testing for QA team. The accepted build will be submitted to the App Store for release.</p>

<p>The first 3 are distributed through <a href="https://get.fabric.io/">Fabric</a>. The last one is, of course, distributed through iTunes Connect. Archiving is done simply through bash scripts. Why did we move away from Fastlane? First of all, our primary need is archiving. We don‚Äôt really need a bunch of other powerful features. The scripts simply perform clean build and archive actions using <code class="language-plaintext highlighter-rouge">xcodebuild</code>. Each of them is less than 100 lines. Secondly, it‚Äôs so much easier and flexible for us to customize our own script. E.g. final modifications to the code before archiving. Lastly, we have one less dependency. That means one less step to provision a new server.</p>

<h3 id="server-side-swift">Server-side Swift</h3>

<p>Now whenever we need a new build we simply execute a script. But the question is, who should do it? It‚Äôs clearly not an option to login to the build machine and do it manually. So again, as a whole bunch of in-house enthusiasts, we wrote a simple app using server-side Swift. The first version was implemented by our teammate <a href="https://github.com/mno2">Paul Meng</a>. It has gone through a few iterations over time.</p>

<p>The app integrates with <a href="https://github.com/pvzig/SlackKit.git">SlackKit</a> using Swift Package Manager and listens to the command from a Slackbot <strong>@iris</strong>. (In case you were wondering, Iris is not someone on the team. Iris is the reverse of Siri üôä. We love Iris.)</p>

<div class="post-image-section">
  <img alt="Goddess Iris" src="/img/ios-automation/goddess-iris.png" width="50%" />
</div>

<div class="post-image-section">
  <img alt="Iris Slack" src="/img/ios-automation/iris-slack.png" width="50%" />
</div>

<p><code class="language-plaintext highlighter-rouge">Irisbot</code> is a Swift class that conforms to <code class="language-plaintext highlighter-rouge">messageEventsDelegate</code> protocol offered by SlackKit. When it receives a message, we parse the message and enqueue a job into a customised serialised <code class="language-plaintext highlighter-rouge">DispatchQueue</code>. Here are a few lines of the main logic.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">received</span><span class="p">(</span><span class="n">_</span> <span class="nv">message</span><span class="p">:</span> <span class="kt">Message</span><span class="p">,</span> <span class="nv">client</span><span class="p">:</span> <span class="kt">Client</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Interpret message to get the command and sanitize user inputs...</span>

  <span class="c1">// Schedule a job.</span>
  <span class="n">archiveQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
    <span class="c1">// Execute scripts based on command.</span>
    <span class="nf">shell</span><span class="p">(</span><span class="s">"bash"</span><span class="p">,</span> <span class="s">"Scripts/</span><span class="se">\(</span><span class="n">jobType</span><span class="o">.</span><span class="n">executableFileName</span><span class="se">)</span><span class="s">"</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
    <span class="c1">// Notify Slack channel when job is done.</span>
    <span class="n">client</span><span class="o">.</span><span class="n">webAPI</span><span class="o">.</span><span class="nf">sendMessage</span><span class="p">(</span><span class="nv">channel</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="s">"job </span><span class="se">\(</span><span class="n">jobID</span><span class="se">)</span><span class="s"> completed"</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="c1">// Send ACK to the channel.</span>
  <span class="n">client</span><span class="o">.</span><span class="n">webAPI</span><span class="o">.</span><span class="nf">sendMessage</span><span class="p">(</span><span class="nv">channel</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="s">"building... your job ID is </span><span class="se">\(</span><span class="n">jobID</span><span class="se">)</span><span class="s">"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now if anyone needs a build they can trigger it themselves. üéâ</p>

<div class="post-image-section">
  <img alt="Corgi Macbook" src="/img/ios-automation/corgi-macbook-meme.jpg" width="80%" />
  <small class="post-image-caption">Literally anyone</small>
</div>

<h3 id="deployments">Deployments</h3>

<p>We sometimes add new features to <strong>@iris</strong> or modify build scripts. How to deploy those changes? We did it with a little help of Capistrano. Here is how:</p>

<p>The plain Iris project looks like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚îú‚îÄ‚îÄ Package.swift
‚îú‚îÄ‚îÄ Package.pins
‚îú‚îÄ‚îÄ Packages
‚îú‚îÄ‚îÄ Sources
‚îÇ   ‚îî‚îÄ‚îÄ main.swift
‚îî‚îÄ‚îÄ Scripts
</code></pre></div></div>

<p>Additional files after Capistrano look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚îú‚îÄ‚îÄ Gemfile
‚îú‚îÄ‚îÄ Gemfile.lock
‚îú‚îÄ‚îÄ Capfile
‚îú‚îÄ‚îÄ config
‚îÇ   ‚îú‚îÄ‚îÄ deploy
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ production.rb
‚îÇ   ‚îî‚îÄ‚îÄ deploy.rb
‚îî‚îÄ‚îÄ lib
    ‚îî‚îÄ‚îÄ capistrano
            ‚îî‚îÄ‚îÄ tasks
</code></pre></div></div>

<p>Iris doesn‚Äôt have a staging environment. So simply config the server IPs in <code class="language-plaintext highlighter-rouge">production.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span> <span class="s1">'x.x.x.x'</span><span class="p">,</span> <span class="ss">user: </span><span class="s1">'XCode Server User Name'</span>
</code></pre></div></div>

<p>And then a set of variables in <code class="language-plaintext highlighter-rouge">deploy.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s2">"osx-server"</span>
<span class="n">set</span> <span class="ss">:repo_url</span><span class="p">,</span> <span class="s2">"git@github.com:xxx/xxxxx.git"</span>
<span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">"/path/to/wherever"</span>
<span class="n">set</span> <span class="ss">:keep_releases</span><span class="p">,</span> <span class="mi">2</span>
<span class="n">ask</span> <span class="ss">:branch</span><span class="p">,</span> <span class="sb">`git rev-parse --abbrev-ref HEAD`</span><span class="p">.</span><span class="nf">chomp</span>
<span class="n">append</span> <span class="ss">:linked_files</span><span class="p">,</span> <span class="s2">"config.json"</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">linked_files</code> will symlink any file in the <code class="language-plaintext highlighter-rouge">shared/</code> folder on the server into the current project directory. Here we linked a <code class="language-plaintext highlighter-rouge">config.json</code> which consists of the path to the iOS passenger app repo on the server and where to put the generated <code class="language-plaintext highlighter-rouge">.xcarchive</code> and <code class="language-plaintext highlighter-rouge">.ipa</code> files. So that people can pass in a different value in their local machine when they want to test out their changes.</p>

<p>We are all set. How simple is that! To deploy üöÄ, simply execute <code class="language-plaintext highlighter-rouge">cap production deploy</code>.
Screwed up? <code class="language-plaintext highlighter-rouge">cap production deploy:rollback</code> will rescue.</p>

<h3 id="conclusion">Conclusion</h3>

<p>What Grab has now, isn‚Äôt the most mature setup (there is still a lot to consider. e.g. scaling, authorisation, better logging etc.), but it serves our needs at the moment. Setting up a basic working environment is not hard at all, it took an engineer slightly over a week. Every team and product has its unique needs and preferences, so do what works for you! We hope this article has given you some insights on some of the decisions made by the iOS team at Grab. We would love to hear about your experience in the comments below.</p>

<p>Happy automating!</p>

      </article>
      <div>
        
          <div class="post-tags">
  
  
    <a href="/tags#continuous-delivery" class="label tags-label">Continuous Delivery</a>
  
    <a href="/tags#ios" class="label tags-label">iOS</a>
  
    <a href="/tags#mobile" class="label tags-label">Mobile</a>
  
    <a href="/tags#swift" class="label tags-label">Swift</a>
  
</div>

        
        <br>
      </div>
      <div class="sharing-links text-right">
  Share on &nbsp;
  <a href="https://twitter.com/intent/tweet?text=Deep Dive into iOS Automation at Grab - Continuous Delivery&url=https://engineering.grab.com/deep-dive-into-ios-automation-at-grab-continuous-delivery&via=grabengineering&related=grabengineering" class="btn btn-sm btn-share btn-share-twitter" rel="nofollow" target="_new" title="Share on Twitter" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-twitter"></i>&nbsp; Twitter</a>
  <a href="https://facebook.com/sharer.php?u=https://engineering.grab.com/deep-dive-into-ios-automation-at-grab-continuous-delivery" class="btn btn-sm btn-share btn-share-facebook" rel="nofollow" target="_new" title="Share on Facebook" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-facebook"></i>&nbsp; Facebook</a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://engineering.grab.com/deep-dive-into-ios-automation-at-grab-continuous-delivery&title=Deep Dive into iOS Automation at Grab - Continuous Delivery
&summary=This is the second part of our series "Deep Dive into iOS Automation at Grab", where we will cover how we manage continuous delivery. As a common solution to Apple developer account device whitelist limitation, we use an enterprise account to distribute beta apps internally. There are 4 build configurations per target.&source=Grab Tech" class="btn btn-sm btn-share btn-share-linkedin" rel="nofollow" target="_new" title="Share on LinkedIn" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-linkedin"></i>&nbsp; LinkedIn</a>
</div>
<script>
  function onShareButtonClick(button) {
    var width = 600;
    var height = 600;
    var left = (window.screen.width / 2) - (width / 2);
    var top = (window.screen.height / 2) - (height / 2);
    window.open(button.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=' + height + ',width=' + width + ',top=' + top + ',left=' + left);
    return false;
  }
</script>

      <hr class="section-divider">

      <br/>
      <!-- 
        <div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = 'https://engineering.grab.com/deep-dive-into-ios-automation-at-grab-continuous-delivery';
    this.page.identifier = '/deep-dive-into-ios-automation-at-grab-continuous-delivery';
  };
  (function() {
    var d = document, s = d.createElement('script');
    s.src = '//grabengineering.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

       -->

    </div>
  </div>
</div>

    </div>
    <div class="progress-wrap">
    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98" />
    </svg>
    <i class="fa fa-chevron-up btt-btn"></i>
</div>
    <footer class="site-footer">
  <div class="wrapper">
    <div class="row">
      <div class="col-sm-6 col-xs-12">
        <h2 class="footer-heading">Grab Tech</h2>
        <ul class="social-media-list">
  
    <li>
      <a href="https://github.com/grab" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-github fa-lg"></i>
      </a>
    </li>
  
  
    <li>
      <a href="https://www.linkedin.com/company/grabapp" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-linkedin fa-lg"></i>
      </a>
    </li>
  
  <li>
    <a href="https://engineering.grab.com/feed.xml" target="_blank">
      <i class="fa fa-rss fa-lg"></i>
    </a>
  </li>
</ul>

        <div>
          <script src="//platform.linkedin.com/in.js" type="text/javascript"> lang: en_US</script>
          <script type="IN/FollowCompany" data-id="5382086" data-counter="right"></script>
        </div>        
        <br>
      </div>
      <div class="col-sm-6 col-xs-12 hiring-section">
        <h2 class="footer-heading">Join Us</h2>
        <p class="text">
          Want to join us in our mission to revolutionize transportation?
        </p>
        <a class="btn" href="https://grab.careers" target="_blank">View open positions</a>

      </div>
    </div>
    
  <!-- Google Tag Manager -->
  <script>
    (function (w, d, s, l, i) {
      w[l] = w[l] || [];
      w[l].push({
        'gtm.start': new Date().getTime(),
        event: 'gtm.js'
      });
      var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != 'dataLayer' ? '&l=' + l : '';
      j.async = true;
      j.src =
        'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
      f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-T3CT72T');
  </script>
  <!-- End Google Tag Manager -->

  <!-- Old script 
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'GTM-T3CT72T', 'auto');
    ga('send', 'pageview');
  </script> -->
<!-- End of olf script -->


  </body>
</html>
