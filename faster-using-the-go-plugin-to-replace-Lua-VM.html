<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>2.3x faster using the Go plugin to replace Lua virtual machine</title>
    <meta name="description" content="The Talaria open-source project has made significant improvements by replacing Lua VM with the Go plugin resulting in 2.3x faster performance and memory usage reduction. Talaria is a time-series database designed for Big Data systems used to process millions of transactions and connections daily at Grab, requiring scalable data-driven decision-making.">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Open Graph -->
    <meta property="og:url" content="https://engineering.grab.com/faster-using-the-go-plugin-to-replace-Lua-VM">
    <meta property="og:title" content="2.3x faster using the Go plugin to replace Lua virtual machine">
    <meta property="og:description" content="The Talaria open-source project has made significant improvements by replacing Lua VM with the Go plugin resulting in 2.3x faster performance and memory usage reduction. Talaria is a time-series database designed for Big Data systems used to process millions of transactions and connections daily at Grab, requiring scalable data-driven decision-making.">
    <meta property="og:site_name" content="Grab Tech">
    <meta property="og:type" content="article">
    <meta property="og:image" content="https://engineering.grab.com/img/faster_using_the_go_plugin_to_replace_Lua_VM/cover.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Favicons -->
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <!-- CSS -->
    <link href="//fonts.googleapis.com/css?family=Droid+Serif:400,400i,700,700i" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://engineering.grab.com/faster-using-the-go-plugin-to-replace-Lua-VM">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS for Official Grab Tech Blog" href="/feed.xml">
</head>

  <body>
    <header class="site-header">
  <div class="wrapper-navbar">
    <div class="site-title-wrapper">
      <div class="row site-title-wrapper-inner">
        <div class="col-xs-1 visible-xs hamburger-nav" id="mobile-menu-btn">
          <div class="menu-btn"></div>
        </div>
        <div class="col-sm-3 col-xs-3">
          <div class="site-title-container">
            <a class="site-title" href="/"></a>
            <span class="site-subtitle">&nbsp;Tech Blog</span>
          </div>
        </div>
        <div class="col-sm-9 col-xs-8 text-right">
          <ul class="nav-category hidden-xs">
            
              
              <li>
                <a href="/categories/engineering/">Engineering</a>
              </li>
            
              
              <li>
                <a href="/categories/data-science/">Data Science</a>
              </li>
            
              
              <li>
                <a href="/categories/design/">Design</a>
              </li>
            
              
              <li>
                <a href="/categories/product/">Product</a>
              </li>
            
              
              <li>
                <a href="/categories/security/">Security</a>
              </li>
            
          </ul>
          <div class="site-search text-right">
            <form action="/search.html" role="search" class="search-form">
  <div class="search-icon"> </div>
  <input type="search" name="q" class="search-text" placeholder="Search...">
  <button class="search-submit"><i class="fa fa-chevron-right"></i></button>
</form>
    

          </div>
        </div>
      </div>
      <!--  Only visible on mobile view -->
      <div class="mobile-menu-container">
        <ul class="mobile-menu">
          
            
            <li>
              <a href="/categories/engineering/">Engineering</a>
            </li>
          
            
            <li>
              <a href="/categories/data-science/">Data Science</a>
            </li>
          
            
            <li>
              <a href="/categories/design/">Design</a>
            </li>
          
            
            <li>
              <a href="/categories/product/">Product</a>
            </li>
          
            
            <li>
              <a href="/categories/security/">Security</a>
            </li>
          
        </ul>
      </div>
    </div>
  </div>
</header>
<script src="/js/main.js"></script>

    <div class="page-content">
      
<div class="wrapper">
  <div class="post">
    <header class="post-header">
      <img src="/img/faster_using_the_go_plugin_to_replace_Lua_VM/cover.png" class="post-cover-photo" alt="2.3x faster using the Go plugin to replace Lua virtual machine cover photo">
      
        
          <a class="post-category" href="/categories/engineering/">Engineering </a>
      

      <h1 class="post-title">2.3x faster using the Go plugin to replace Lua virtual machine</h1>
      
      <div class="post-meta">
        <div class="row">
          <div class="col-xs-12">
            <div class="post-author-thumbnail-container">
              
                
                
                  <img class="post-author-thumbnail-large img-circle" src="/img/authors/yonghao.hu.png">
                
              
                
                
                  <img class="post-author-thumbnail-large img-circle" src="/img/authors/fabianto-wangsamulya.png">
                
              
            </div>

            <div class="post-meta-text-container">
              <span class="post-author-large">
                
                  
                  
                    
                    <a href="/authors#yonghao-hu">Yonghao Hu</a>
                  
                
                  
                  
                    
                      &middot;
                    
                    <a href="/authors#fabianto-wangsamulya">Fabianto Wangsamulya</a>
                  
                
              </span>
              <span class="post-date-large">15 May 2023 | 5 min read</span>
            </div>
          </div>
        </div>
      </div>

    </header>
    <div class="wrapper-content">
      <article class="post-content">
        <h2 id="abstract">Abstract</h2>
<p>We’re excited to share with you the latest update on our open-source project <a href="https://github.com/kelindar/talaria">Talaria</a>. In our efforts to improve performance and overcome infrastructure limitations, we’ve made significant strides by implementing the <a href="https://pkg.go.dev/plugin">Go plugin</a> to replace Lua VM.</p>

<p>Our team has found that the <a href="https://pkg.go.dev/plugin">Go plugin</a> is roughly 2.3x faster and uses 2.3x less memory than the Lua VM. This significant performance boost has helped us improve overall functionality, scalability, and speed.</p>

<p>For those who aren’t familiar, Talaria is a distributed, highly available, and low-latency time-series database that’s designed for Big Data systems. <a href="https://engineering.grab.com/big-data-real-time-presto-talariadb">Originally developed and implemented at Grab</a>, Talaria is a critical component in processing millions and millions of transactions and connections every day, which demands scalable, data-driven decision-making.</p>

<h2 id="background">Background</h2>
<p>One of the methods we previously used for processing ingested data was <a href="https://github.com/talariadb/talaria/blob/51560d23faed1c0d8174531142ef3314cfdc86b1/internal/scripting/script_test.go#L14">Lua script</a>. This method allowed users to customise the ingestion process, providing a high degree of flexibility.</p>

<p>The config below is an example of using Lua script to JSON encode the row as a data column:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>computed:
  - name: data
    type: json
    func: |
      local json = require("json")
      function main(row)
        return json.encode(row)
      end     
</code></pre></div></div>

<h2 id="problem">Problem</h2>
<p>We found that loading a Lua script required launching a Lua virtual machine (VM) to execute the script, which had a significant impact on performance, especially when ingesting large amounts of events.</p>

<p>This performance issue led us to reevaluate our approach to processing ingested data and make changes to improve Talaria’s performance.</p>

<p>As a result, this is the code we used on Lua VM to run the trim, remove keys “key1”, “key2”, “key3”, “key4”, “key5”, in the ingested data:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import "github.com/kelindar/lua"

func luaTrim() string {
    s, err := lua.FromString("test.lua", `
    local json = require("json")
    local keys = {
    "key1", "key2", "key3", "key4", "key5",
    }
    function main(input)
        local data = json.decode(input)
        for i, key in ipairs(keys) do
            data[key] = nil
        end
        return json.encode(data)
    end
`)
    if err != nil {
        panic(err)
    }
    result, err := s.Run(context.Background(), jsonstr)
    if err != nil {
        panic(err)
    }
    return result.String()
}
</code></pre></div></div>

<p>Here is the benchmark, using Lua VM is 1000 times slower and uses 1000 times more memory than Golang’s native function on a Trim function:</p>

<table class="table">
  <thead>
    <tr>
      <th>BenchmarkTrim-12  </th>
      <th>543541 </th>
      <th>2258 ns/op</th>
      <th>848 B/op</th>
      <th>12 allocs/op</th>
    </tr>
  </thead>
  <thead>
    <tr>
      <th>BenchmarkLuaTrim-12 </th>
      <th>553</th>
      <th>2105506 ns/op</th>
      <th>5006319 B/op</th>
      <th>10335 allocs/op</th>
    </tr>
  </thead>
</table>

<p>But, anything can be improved by adding a cache, what if we cache the Lua VM and reuse them? Here is the new improved benchmark:</p>

<table class="table">
  <thead>
    <tr>
      <th>BenchmarkTrim-8</th>
      <th>232105 </th>
      <th>4995 ns/op </th>
      <th>2192 B/op </th>
      <th>53 allocs/op</th>
    </tr>
  </thead>
  <thead>
    <tr>
      <th>BenchmarkLuaTrim-8</th>
      <th>97536</th>
      <th>12108 ns/op </th>
      <th>4573 B/op </th>
      <th>121 allocs/op</th>
    </tr>
  </thead>
</table>

<p>So we can conclude that Lua VMs are roughly 2.3x faster and use 2.3x less memory than Golang’s native function.</p>

<h2 id="use-the-go-plugin-as-lua-vm-to-execute-custom-code">Use the Go plugin as Lua VM to execute custom code</h2>
<p>We came up with the idea of using a <a href="https://developer.ibm.com/tutorials/l-dynamic-libraries/">Linux shared library</a> to execute the custom function instead of using Lua VM to run the custom script. Maybe you will be more familiar with the files with suffixes <code class="language-plaintext highlighter-rouge">.so</code>; they are shared libraries designed to package similar functionality in a single unit and shared with other developers so that they can call the function without writing it again.</p>

<p>In Golang, a similar idea is called <a href="https://pkg.go.dev/plugin">Go plugin</a>, which allows you to build Golang code as a shared library (Golang names it a plugin). Open this file and call the Go function inside this plugin.</p>

<h3 id="how-to-use-the-go-plugin">How to use the Go plugin</h3>
<p>Let’s say you have a function F that wants to be called via the plugin.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>package main
import "fmt"
func F() { fmt.Printf("Hello, world") }
</code></pre></div></div>

<p>After writing the function F, you can compile it as a Go plugin file f_plugin.so via Go build -buildmode=plugin -o f_plugin.so. And you can open the file and use the function F like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p, err := plugin.Open("f_plugin.so")
if err != nil {
    panic(err)
}
f, err := p.Lookup("F")
if err != nil {
    panic(err)
}
f.(func())() // prints "Hello, world"
</code></pre></div></div>

<h3 id="go-plugin-benchmark">Go plugin benchmark</h3>
<p>Here is the result that compares Golang native function, Golang plugin call.</p>

<p>Golang native function: 2.3x faster and 2.3x lesser memory than using the Lua VM.
Golang plugin call has almost the same performance as Golang native function.</p>

<table class="table">
  <thead>
    <tr>
      <th>BenchmarkNativeFunctionCall-12</th>
      <th>2917465 </th>
      <th>401.7 ns/op </th>
      <th>200 B/op</th>
      <th>6 allocs/op</th>
    </tr>
  </thead>
  <thead>
    <tr>
      <th>BenchmarkPluginCall-12</th>
      <th>2778988 </th>
      <th>447.1 ns/op  </th>
      <th>200 B/op </th>
      <th>6 allocs/op</th>
    </tr>
  </thead>
</table>

<h3 id="integrated-into-talaria">Integrated into Talaria</h3>
<p>This is the MR we integrated the Go plugin into Talaria: <a href="https://github.com/talariadb/talaria/pull/87">https://github.com/talariadb/talaria/pull/87</a>, adding it as a loader like LuaLoader.</p>

<p>They both implemented the Handler interfaces.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type Handler interface {
    Load(uriOrCode string) (Handler, error)
    String() string
    Value(map[string]interface{}) (interface{}, error)
}
</code></pre></div></div>
<p>The implementation of this interface is listed here:</p>

<h4 id="for-lua-loader">For Lua loader</h4>

<p><strong>Load</strong>: Load the Lua code or Lua script file path (local file path or s3 path) as the loader.</p>

<p><strong>String</strong>: Return “lua” so that we can call it to get what the loader is.</p>

<p><strong>Value</strong>: Run the Lua script, and take the arg as input.</p>

<h4 id="for-go-plugin-loader">For Go plugin loader</h4>

<p><strong>Load</strong>: Read the plugin file path (local file path or s3 path) as the plugin, lookup the function name defined by the user, save the function for later use.</p>

<p><strong>String</strong>: Return “plugin” so that we can call it to get what the loader is.</p>

<p><strong>Value</strong>: Run the saved function, take the arg as input.</p>

<h2 id="things-you-need-to-notice">Things you need to notice</h2>
<p>The Go version you used to build the  Golang plugin must be the same as the service used in that plugin. We use Docker to build the service, so that we can ensure the Go version is the same.</p>

<h2 id="reference-benchmark-plugin-and-lua">Reference (Benchmark plugin and LUA)</h2>
<p>https://github.com/atlas-comstock/talaria_benchmark/tree/master/benchmark_plugin_and_lua</p>

<h1 id="join-us">Join us</h1>
<p>Grab is the leading superapp platform in Southeast Asia, providing everyday services that matter to consumers. More than just a ride-hailing and food delivery app, Grab offers a wide range of on-demand services in the region, including mobility, food, package and grocery delivery services, mobile payments, and financial services across 428 cities in eight countries.</p>

<p>Powered by technology and driven by heart, our mission is to drive Southeast Asia forward by creating economic empowerment for everyone. If this mission speaks to you, <a href="https://grab.careers/">join our team</a> today!</p>

      </article>
      <div>
        
          <div class="post-tags">
  
  
    <a href="/tags#engineering" class="label tags-label">Engineering</a>
  
    <a href="/tags#faster" class="label tags-label">Faster</a>
  
    <a href="/tags#go-plugin" class="label tags-label">Go plugin</a>
  
    <a href="/tags#lua-vm" class="label tags-label">Lua VM</a>
  
    <a href="/tags#virtual-machines" class="label tags-label">Virtual machines</a>
  
</div>

        
        <br>
      </div>
      <div class="sharing-links text-right">
  Share on &nbsp;
  <a href="https://twitter.com/intent/tweet?text=2.3x faster using the Go plugin to replace Lua virtual machine&url=https://engineering.grab.com/faster-using-the-go-plugin-to-replace-Lua-VM&via=grabengineering&related=grabengineering" class="btn btn-sm btn-share btn-share-twitter" rel="nofollow" target="_new" title="Share on Twitter" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-twitter"></i>&nbsp; Twitter</a>
  <a href="https://facebook.com/sharer.php?u=https://engineering.grab.com/faster-using-the-go-plugin-to-replace-Lua-VM" class="btn btn-sm btn-share btn-share-facebook" rel="nofollow" target="_new" title="Share on Facebook" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-facebook"></i>&nbsp; Facebook</a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://engineering.grab.com/faster-using-the-go-plugin-to-replace-Lua-VM&title=2.3x faster using the Go plugin to replace Lua virtual machine
&summary=The Talaria open-source project has made significant improvements by replacing Lua VM with the Go plugin resulting in 2.3x faster performance and memory usage reduction. Talaria is a time-series database designed for Big Data systems used to process millions of transactions and connections daily at Grab, requiring scalable data-driven decision-making.&source=Grab Tech" class="btn btn-sm btn-share btn-share-linkedin" rel="nofollow" target="_new" title="Share on LinkedIn" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-linkedin"></i>&nbsp; LinkedIn</a>
</div>
<script>
  function onShareButtonClick(button) {
    var width = 600;
    var height = 600;
    var left = (window.screen.width / 2) - (width / 2);
    var top = (window.screen.height / 2) - (height / 2);
    window.open(button.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=' + height + ',width=' + width + ',top=' + top + ',left=' + left);
    return false;
  }
</script>

      <hr class="section-divider">

      <br/>
      <!-- 
        <div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = 'https://engineering.grab.com/faster-using-the-go-plugin-to-replace-Lua-VM';
    this.page.identifier = '/faster-using-the-go-plugin-to-replace-Lua-VM';
  };
  (function() {
    var d = document, s = d.createElement('script');
    s.src = '//grabengineering.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

       -->

    </div>
  </div>
</div>

    </div>
    <div class="progress-wrap">
    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98" />
    </svg>
    <i class="fa fa-chevron-up btt-btn"></i>
</div>
    <footer class="site-footer">
  <div class="wrapper">
    <div class="row">
      <div class="col-sm-6 col-xs-12">
        <h2 class="footer-heading">Grab Tech</h2>
        <ul class="social-media-list">
  
    <li>
      <a href="https://github.com/grab" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-github fa-lg"></i>
      </a>
    </li>
  
  
    <li>
      <a href="https://www.linkedin.com/company/grabapp" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-linkedin fa-lg"></i>
      </a>
    </li>
  
  <li>
    <a href="https://engineering.grab.com/feed.xml" target="_blank">
      <i class="fa fa-rss fa-lg"></i>
    </a>
  </li>
</ul>

        <div>
          <script src="//platform.linkedin.com/in.js" type="text/javascript"> lang: en_US</script>
          <script type="IN/FollowCompany" data-id="5382086" data-counter="right"></script>
        </div>        
        <br>
      </div>
      <div class="col-sm-6 col-xs-12 hiring-section">
        <h2 class="footer-heading">Join Us</h2>
        <p class="text">
          Want to join us in our mission to revolutionize transportation?
        </p>
        <a class="btn" href="https://grab.careers" target="_blank">View open positions</a>

      </div>
    </div>
    
  <!-- Google Tag Manager -->
  <script>
    (function (w, d, s, l, i) {
      w[l] = w[l] || [];
      w[l].push({
        'gtm.start': new Date().getTime(),
        event: 'gtm.js'
      });
      var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != 'dataLayer' ? '&l=' + l : '';
      j.async = true;
      j.src =
        'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
      f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-T3CT72T');
  </script>
  <!-- End Google Tag Manager -->

  <!-- Old script 
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'GTM-T3CT72T', 'auto');
    ga('send', 'pageview');
  </script> -->
<!-- End of olf script -->


  </body>
</html>
