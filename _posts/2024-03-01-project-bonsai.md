---
layout: post
id: 2024-03-01-project-bonsai
title: "Android App Size at Scale with Project Bonsai"
date: 2024-03-01 02:22:10
authors: [van-minh]
categories: [Engineering]
tags: [App size, Optimisation, Project Bonsai, App download size, App disk size, Scalability]
comments: true
cover_photo: /img/project-bonsai/cover.png
excerpt: "With the size of our app growing to include more features, Grab recognised it as a potential hurdle for new users with small storage capacities or restricted Internet bandwidth. Read to find out more about Project Bonsai and how it reduced app download size and app disk size."
---

Grab is Southeast Asia's leading superapp, providing a suite of services that brings essential needs to users throughout the region. Its offerings include ride-hailing, food delivery, parcel delivery, mobile payments, and more. With safety, efficiency, and user-centered design at heart, Grab remains dedicated to solving everyday issues and improving the lives of millions.

As the app continues to expand with more features, Grab identified the need for a consistent, high-quality experience for new users who may have limited storage space or restricted internet bandwidth. Read to find out more about Project Bonsai and how it reduced app download size and app disk size.

## Introduction

In 2020, Google conducted research that highlighted the [negative impact of app sizes on conversion rates](https://medium.com/googleplaydev/shrinking-apks-growing-installs-5d3fcba23ce2), revealing a 1% decrease for every 6MB expansion of the app APK size. This finding prompted Grab to ensure new and existing users had a consistently excellent [Grab superapp](https://play.google.com/store/apps/details?id=com.grabtaxi.passenger) experience, given the prevalence of low-end devices and disparate internet infrastructure in Southeast Asian regions. As a result, Grab initiated **Project Bonsai** in Q3 2021, with the goal of reducing and optimising the app size while enhancing user experience, reducing installation barriers, and boosting user acquisition.

### Understanding the problem

The [Grab superapp](https://play.google.com/store/apps/details?id=com.grabtaxi.passenger), with over 4 million lines of code and integration with hundreds of third-party libraries, had a significant app size. Given the prevalence of low-end devices and disparate internet infrastructure in our target region, it is crucial for us to proactively and constantly ensure we are delivering excellence in app-based user experience.

### Objectives of the Bonsai project

The Bonsai project focused on these two key metrics:

*   **App Download Size**: This represents the total size of the compressed APK file that users need to download from Google Play when performing a fresh installation.
*   **App Disk Size**: This encompasses the total storage space occupied by the app on user devices, including both the binary and data generated by the app.

In this article, we will share the strategy and solutions that resulted in a successful **26% reduction in App Download Size**, while also reducing the App Disk Size.

### Status quo

Prior to the Bonsai project, the Grab app project had implemented various measures to achieve optimal app size. Here are some notable highlights:

*   **Leveraging App Bundle**: Since 2019, Grab has been using the app bundle approach to optimise app delivery. This approach generates smaller APKs tailored to specific device configurations, ensuring users receive optimised APKs. This helps reduce the overall app size and improve installation efficiency.

*   **Monitoring**: With a team of over 100 Android engineers and multiple collaborative teams, the Grab app undergoes a weekly release process involving hundreds of commits for each release. Closely monitoring app size changes with every commit is essential for our team. The team established debug build (APK file size) monitoring for **every commit merged to the master branch**. Regular weekly reviews are conducted to stay updated on the app size and identify commits that might lead to changes in app size. However, occasional mismatches may occur due to discrepancies between the debug and release builds.

<div class="post-image-section"><figure>
  <img src="/img/project-bonsai/image1.png" alt="" style="width:70%"><figcaption align="middle">Monitoring the changes in APK size</figcaption>
  </figure>
</div>


*   **R8 Integration**: R8/Proguard, known as the code shrinker, obfuscator, and optimiser, has been enabled since the beginning. This powerful tool helps reduce the app's bytecode and resources, leading to further size optimisation and improved app performance.

*   **Resource Optimisation**: The team diligently pursued resource optimisation strategies, including:

    *   Images: Engineers were encouraged to use vector images whenever possible, as they usually have smaller file sizes than raster images. In exceptional cases where raster images were necessary, Grab adopted the webp format instead of png, utilising better image compression to minimise app size.
    *   Language ResourceConfig: Grab enabled resourceConfig to support only the languages actively used by the Grab app, reducing unnecessary resource overhead and enhancing app efficiency.

*   **Third-Party Libraries Review**: The team established a review process for third-party libraries, assessing their size impact on the app. This practice ensured that only essential libraries were included, preventing unnecessary bloating of the app size.

Despite the application of these measures and solutions aimed at managing the app size, there was still the potential of significant expansion in magnitude.

## Strategy

The Bonsai project revolves around strategic pillars, namely Measurement, Reduction, and Containment.

<div class="post-image-section"><figure>
  <img src="/img/project-bonsai/image7.png" alt="" style="width:70%"><figcaption align="middle">Project Bonsai's three strategic pillars for continuous app size reduction</figcaption>
  </figure>
</div>

In the **Measurement** phase, the focus is on providing accurate information on the app’s binary composition and how individual features, modules, libraries impact the overall app size. This allows teams to make informed decisions and gain insights into their components’ influence on the app's size.

The insights from the Measure phase provided us with a list of actionable items for our backlog. In the **Reduction** phase, we employ strategic action to tackle this backlog to constantly achieve optimal app size.

Optimising the app size is not a one-time endeavour, especially as more features are added over time, potentially increasing the project's size. While there may be limited solutions to manage app size, it’s important to find a balance between size and functionality. Else, the effort and trade-offs required may become overwhelming. Therefore, in the **Containment** phase, we intend to introduce effective long-term strategies and solutions designed to manage the app's size.

In the remainder of this blog post, we explore the strategic pillars and actions taken to contain the download size.

### Measure

The Grab Passenger App Core team actively engages in optimisation projects and recognised the importance of measurement as the foundation for improvement. For example, enhancing the app startup time, pipeline time, build time, and more.

In every optimisation endeavour, we adhere to a crucial principle: "MEASURE" - the first and most critical step for any improvement project. As the famous quote goes, "If you can't measure it, you can't improve it." This emphasises the significance of accurate and comprehensive measurement as the foundation for driving successful optimisation efforts.

In the third quarter of 2021, our team initiated an investigation into existing tools provided by both Google and the broader community. The intention was to employ tools such as [APK Analyzer](https://developer.android.com/tools/apkanalyzer) or Android Studio to conduct a thorough analysis of the app binary. However, it soon became evident that these tools were not well-suited to accommodate the extensive scope of our project.

In order to accommodate our discovery, we developed a custom analytics tool called App Sizer. This tool is specifically designed to analyse app binaries from bundle files. Our primary goal was to construct a solution that adheres effectively to our unique needs.

The tool was seamlessly integrated into Grab’s CI system and sends data to a [Grafana](https://grafana.com/) instance. As a result, the tool collates and transmits daily analytics data from the release candidate branch. It offers the following key functionalities and monitors important aspects such as:

**Device-specific App Download Size**: Precise information about the app download size for specific devices, focusing on optimising the App Download Size.

<div class="post-image-section"><figure>
  <img src="/img/project-bonsai/image3.png" alt="" style="width:100%"><figcaption align="middle">Trends for app download size by device type</figcaption>
  </figure>
</div>

**Comprehensive Size Breakdown**: A breakdown of the app's size, including the proportion attributed to the codebase Kotlin/Java, Kotlin/Java-based libraries, native libraries, resources, and other relevant factors.

<div class="post-image-section"><figure>
  <img src="/img/project-bonsai/image6.png" alt="" style="width:100%"><figcaption align="middle">Comprehensive breakdown of app download size by component</figcaption>
  </figure>
</div>

**Size Contribution by Teams**: Insights into the size contributed by each individual team within the project's scope.

<div class="post-image-section"><figure>
  <img src="/img/project-bonsai/image5.png" alt="" style="width:100%"><figcaption align="middle">Breakdown of Grab's codebase by TF</figcaption>
  </figure>
</div>

**Module-wise Size Contribution**: Insights into the size impacted by each module, categorised by team.

<div class="post-image-section"><figure>
  <img src="/img/project-bonsai/image8.png" alt="" style="width:100%"><figcaption align="middle">Breakdown of the codebase by TF modules</figcaption>
  </figure>
</div>

**Size Contribution by Third-Party Libraries**: Information about the size attributed to each third-party library incorporated within the app.

<div class="post-image-section"><figure>
  <img src="/img/project-bonsai/image2.png" alt="" style="width:100%"><figcaption align="middle">App download size contribution by external libraries and SDK breakdown</figcaption>
  </figure>
</div>

**List of Large Files**: A categorised list of large files (file size exceeding X value), organised by each respective team.

<div class="post-image-section"><figure>
  <img src="/img/project-bonsai/image4.png" alt="" style="width:100%"><figcaption align="middle">Large file categories broken down by TF</figcaption>
  </figure>
</div>

It's important to note that all the size values presented within these dashboards specifically pertain to the download size, representing the contribution of each item to the overall app download size.

As part of our commitment to the developer community, we plan to open-source this tool in the near future, allowing others to benefit from its capabilities as well.

### Reduce

To optimise the app based on the analysis data obtained from the measuring step, we focused on applying common solutions from Google and the suggestions from the community. There were no fancy solutions that we invented. Our concentration centered on optimising the [dex file](https://source.android.com/docs/core/runtime/dex-format) size, refining resources, and eliminating duplication and redundancy.

#### dex file optimisation (Java/Kotlin)

In our initial findings, it became evident that Java/Kotlin code was the major contributor of app size. Recognising this, we made it our top priority for optimisation.

<br/>
**R classes**

During our investigation, we discovered that a proportion of the overall app size was attributable to R classes. Further research unveiled two primary reasons behind this phenomenon:

1.  [Transitive R classes](https://www.mobileit.cz/Blog/Pages/r-class.aspx): R classes contained ID references not only to their own resources but also to resources from their transitive dependencies. This meant that if Module A depended on Module B, and Module B in turn, depended on Module C (Module A -> Module B -> Module C), then Module A's R class included IDs references to resources from Modules B and C, even if Module A didn't directly utilise these resources. This explained why R classes in a modularised project could accumulate millions of lines of code.
2.  A spread of Modules and Third-Party Libraries: Our Grab project comprised over 1,500 modules and integrates hundreds of third-party libraries, leading to the generation of significantly large R classes within the project. Furthermore, this discovery also explained instances where our app size monitor exhibited spikes during certain commits despite no significant additions of resources, libraries, or code within those commits. These fluctuations were linked to changes in the dependency graph, further emphasising the impact of Transitive R classes.

It is worth noting that the team had long been cognisant of the challenges posed by Transitive R classes, especially in terms of optimising build times. Consequently, we had already undertaken various initiatives to address this specific challenge related to build times.

However, it wasn't long before we started wondering why R8 wasn't removing unused fields from the R classes, which would have resulted in a size reduction for these classes. It turned out that back in mid-2021, we were using Android Gradle Plugin 4.0 along with the default R8 rules. One of these rules was preserving all fields in the R classes:

```
-keepclassmembers class **.R$* {

   public static <fields>;

}
```

This rule was the root cause of why unused fields in the R classes were persisting. Google removed this [rule in AGP 4.1](https://issuetracker.google.com/issues/142449264), and the solution was straightforward: updating AGP to version 4.1.1 (or newer) helped us resolve the issue.

However, due to the project's unusual size, there was a risk of inadvertently removing non-used R class fields if there were any instances of code accessing R classes through reflection within the codebase or third-party libraries. Since our automation testing did not yet support R8, conducting a full test of the entire project was possible, but would have demanded significant effort from the team. To avoid this substantial effort, we developed a script to search the entire codebase and identify instances where reflections were used, allowing us to assess their usage. For third-party libraries, we decompiled the libraries and applied the same script to the decompiled code.

<br/>
**Fix & Optimise R8 Rules**

Subsequently, we conducted a revision of the R8 configuration rules. This involved assessing the compiled R8 configuration file and paying specific attention to any 'keep' rules that contained package wildcards. It is crucial to decipher the purpose behind each rule and its reason for existence. Any rules identified as redundant were recommended for removal. Post the thorough scrutiny of the R8 rules, we initiated request tickets urging the respective teams to work on the elimination and optimisation of these rules.

<br/>
**Enable more aggressive optimisations**

In 2019, Google began recommending the utilisation of the [proguard-android-optimise.txt](https://android.googlesource.com/platform/sdk/%2B/master/files/proguard-android-optimize.txt) configuration with code optimisation enabled. However, our project's origins predate the introduction of Google's R8, a time when Proguard was the primary tool for code obfuscation and size reduction. Prior to the release of Android Gradle Plugin 3.4.0, there were no explicit recommendations for enabling code optimisations during the minification process. As a result, our project has persisted in using the [proguard-android.txt](https://android.googlesource.com/platform/sdk/%2B/master/files/proguard-android.txt) configuration without activating the code optimisation feature.

Our team has considered adopting a more aggressive approach towards optimisation. This approach spans from exploring the [optimisation mode](https://android.googlesource.com/platform/sdk/%2B/master/files/proguard-android-optimize.txt) to incorporating the [R8 full mode](https://developer.android.com/build/shrink-code). This includes substantial effort required for testing and addressing issues arising from the introduction of these new modes. We encountered a particular challenge wherein the R8 optimisation exhibits instability, an issue that has been [reported to Google](https://issuetracker.google.com/u/1/issues/240077160). A definitive solution remains a work-in-progress.

At present, we have decided to postpone the implementation of a more aggressive R8 mode. However, this remains a high-priority item on our agenda, and we intend to address it in the near future.

#### Resources optimisation

In addition to optimising the dex file, we also address resource optimisation.

<br/>
**Handling large resources**

During the Measure phase, we use the List Of Large Files dashboard to identify large files categorised by teams. For each team, we create request tickets with straightforward guidance. These guidelines encourage the following actions:

*   Explore the possibility of removing unnecessary resources.
*   Consider offloading the resource to the Internet (server) when feasible. Within Grab, we have the Asset Delivery Kit, which facilitates hosting and downloading resources on the client side.
*   Optimise files by converting them to alternative formats or reducing their size. For instance, for images, we recommend utilising vector images and the Webp format, among other optimisations.

<br/>
**Convert PNG to Webp**

The Grab app project has a long history, and while the team has recently established guidelines and implemented CI processes to promote the use of vector and Webp images, there are still existing images that have not been optimised. The team has undertaken an initiative to address these images and has converted all PNG images to Webp format wherever a reduction in file size is achievable.

<br/>
**Fonts**

Fonts are another group of files that have a notable impact on the project's size. We collaborate with the teams to:

*   Remove fonts that are rarely used in the project.
*   Eliminate duplicate fonts.

While the project still contains numerous fonts, we have a project to unify all features and transition to using a single font. Our recommendation is to explore the use of one primary font style, with the flexibility to incorporate different [typeface variations](https://developer.android.com/reference/android/graphics/Typeface) in your programming to achieve various typefaces using the same font.

<br/>
**Remove stale features and replace large library**

Based on the data, it was discovered that a specific library, which was contributing approximately 8% to the overall app size, had an adverse impact. This library has since been removed from the project. Moreover, through analysing the Size Contribution by Third-Party Libraries dashboard, we identified duplicates in functions and have made efforts to eliminate these redundancies.

Moreover, in Grab, we are using the feature toggle to enable or disable a feature. The feature flags are controlled remotely. It’s very useful for running an experiment or turning off if a feature causes us any problems. So, many features in the project are controlled under a feature flag. In certain cases, even when some features are deactivated, the corresponding code remains included in the binary. We identify these cases and collaborate with teams to remove the redundant code.

After six months of working on the above initiatives, the Bonsai team managed to reduce the Grab app download size by **26%**. This is particularly noteworthy, considering that prior to the commencement of the Bonsai Project, the average app size exhibited a monthly increase of approximately 1%.

### Containment

After dedicating over a semester to the Reduce phase, we started the transition to the Containment phase. The first step for this phase involved setting up an App Growth Rate dashboard that presents the growth rate of app download size per release. Our goal is to keep this rate as low as possible.

The team has been discovering a few solutions, such as introducing the common UI design components to prevent duplication, and experimenting with [Dynamic Delivery Feature](https://developer.android.com/guide/playcore/feature-delivery). This phase of exploration is still ongoing and we are optimistic that it will help maintain a manageable app download size, or perhaps even contribute to further optimization.

Considering alternative initiatives, the team is contemplating recognising app size as a confined resource of our application. We believe it should be the responsibility of every team to maintain an optimal app size. Based on the measurements we have, which provide an insight into each team's impact on the total app download size, it could be advantageous to allocate an 'app size budget' to each team. This would entail each team taking responsibility for managing and maintaining the size influenced by their work.

## Conclusion

Grab's Project Bonsai demonstrated the company's commitment to optimising the app experience for users in Southeast Asia. By prioritising code optimisation, resource management, modularisation, and asset bundling, we achieved substantial optimisations in app size while enhancing user experience. These efforts not only addressed the challenges we outlined, but also contributed to increased user acquisition and improved user retention rates.

# Join us

Grab is the leading superapp platform in Southeast Asia, providing everyday services that matter to consumers. More than just a ride-hailing and food delivery app, Grab offers a wide range of on-demand services in the region, including mobility, food, package and grocery delivery services, mobile payments, and financial services across 428 cities in eight countries.

Powered by technology and driven by heart, our mission is to drive Southeast Asia forward by creating economic empowerment for everyone. If this mission speaks to you, [join our team](https://grab.careers/) today!
