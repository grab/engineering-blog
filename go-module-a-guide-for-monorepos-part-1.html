<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Go Modules- A guide for monorepos (Part 1)</title>
    <meta name="description" content="This post is the first in a series of blogs about Grab’s experience with Go modules in a multi-module monorepo. Here, we discuss the challenges we faced along the way and the solutions we came up with.">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Open Graph -->
    <meta property="og:url" content="https://engineering.grab.com/go-module-a-guide-for-monorepos-part-1">
    <meta property="og:title" content="Go Modules- A guide for monorepos (Part 1)">
    <meta property="og:description" content="This post is the first in a series of blogs about Grab’s experience with Go modules in a multi-module monorepo. Here, we discuss the challenges we faced along the way and the solutions we came up with.">
    <meta property="og:site_name" content="Grab Tech">
    <meta property="og:type" content="article">
    <meta property="og:image" content="https://engineering.grab.com/img/go-module-a-guide-for-monorepos-part-1/cover.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Favicons -->
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <!-- CSS -->
    <link href="//fonts.googleapis.com/css?family=Droid+Serif:400,400i,700,700i" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://engineering.grab.com/go-module-a-guide-for-monorepos-part-1">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS for Official Grab Tech Blog" href="/feed.xml">
</head>

  <body>
    <header class="site-header">
  <div class="wrapper">
    <div class="site-title-wrapper">
      <div class="row site-title-wrapper-inner">
        <div class="col-sm-8 col-xs-4">
          <div>
            <a class="site-title" href="/"></a>
            <span class="site-subtitle hidden-xs">&nbsp;Tech Blog</span>
          </div>
        </div>
        <div class="col-sm-4 col-xs-8 text-right site-search">
          <form action="/search.html" method="get">
  <div class="input-group">
    <input type="text" id="search" name="q" class="form-control" placeholder="Search...">
    <span class="input-group-btn">
      <button class="btn" type="submit"><i class="fa fa-search"></i></button>
    </span>
  </div>
</form>

        </div>
      </div>
    </div>
    <nav>
      <ul class="nav-category">
        
          
          <li>
            <a href="/categories/engineering/">Engineering</a>
          </li>
        
          
          <li>
            <a href="/categories/data-science/">Data Science</a>
          </li>
        
          
          <li>
            <a href="/categories/design/">Design</a>
          </li>
        
          
          <li>
            <a href="/categories/product/">Product</a>
          </li>
        
      </ul>
    </nav>
  </div>
</header>

    <div class="page-content">
      
<div class="wrapper">
  <div class="post">
    <header class="post-header">
      <div class="text-center">
        
          
            
            
              <img class="post-author-thumbnail-large img-circle" src="/img/authors/michael-cartmell.jpg">
            
          
        
      </div>
      <br>
      <h1 class="post-title text-center">Go Modules- A guide for monorepos (Part 1)</h1>
      
      <div class="post-meta">
        29 May 2020
        
          
            
            
              &middot;
              <a href="/authors#michael-cartmell">Michael Cartmell</a>
            
          
        
        
        
          <div class="post-tags">
  
  
    <a href="/tags#go" class="label tags-label">Go</a>
  
    <a href="/tags#libraries" class="label tags-label">Libraries</a>
  
    <a href="/tags#monorepo" class="label tags-label">Monorepo</a>
  
    <a href="/tags#vendoring" class="label tags-label">Vendoring</a>
  
    <a href="/tags#vendors" class="label tags-label">Vendors</a>
  
</div>

        
      </div>
    </header>
    <article class="post-content">
      <p><a href="https://github.com/golang/go/wiki/Modules%23quick-start">Go modules</a> are a new feature in Go for versioning packages and managing dependencies. It has been almost 2 years in the making, and it’s finally production-ready in the Go 1.14 release early this year. Go recommends using single-module repositories by default, and warns that multi-module repositories require great care.</p>

<p>At Grab, we have a large monorepo and changing from our existing monorepo structure has been an interesting and humbling adventure. We faced serious obstacles to fully adopting Go modules. This series of articles describes Grab’s experience working with Go modules in a multi-module monorepo, the challenges we faced along the way, and the solutions we came up with.</p>

<p>To fully appreciate Grab’s journey in using Go Modules, it’s important to learn about the beginning of our vendoring process.</p>

<h2 id="native-support-for-vendoring-using-the-vendor-folder">Native support for vendoring using the vendor folder</h2>

<p>With Go 1.5 came the concept of the <code class="highlighter-rouge">vendor</code> folder, a new package discovery method, providing native support for vendoring in Go for the first time.</p>

<p>With the <code class="highlighter-rouge">vendor</code> folder, projects influenced the lookup path simply by copying packages into a <code class="highlighter-rouge">vendor</code> folder nested at the project root. Go uses these packages before traversing the <code class="highlighter-rouge">GOPATH</code> root, which allows a monorepo structure to vendor packages within the same repo as if they were 3rd-party libraries. This enabled <code class="highlighter-rouge">go build</code> to work consistently without any need for extra scripts or env var modifications.</p>

<h3 id="initial-obstacles">Initial obstacles</h3>

<p>There was no official command for managing the <code class="highlighter-rouge">vendor</code> folder, and even copying the files in the <code class="highlighter-rouge">vendor</code> folder manually was common.</p>

<p>At Grab, different teams took different approaches. This meant that we had multiple version manifests and lock files for our monorepo’s vendor folder. It worked fine as long as there were no conflicts. At this time very few 3rd-party libraries were using proper tagging and semantic versioning, so it was worse because the lock files were largely a jumble of commit hashes and timestamps.</p>

<div class="post-image-section"><figure>
  <img src="/img/go-module-a-guide-for-monorepos-part-1/image2.png" alt="Jumbled commit hashes and timestamps" />
  <figcaption align="middle"><i>Jumbled commit hashes and timestamps</i></figcaption>
</figure></div>

<p>As a result of the multiple versions and lock files, the vendor directory was not reproducible, and we couldn’t be sure what versions we had in there.</p>

<h3 id="temporary-relief">Temporary relief</h3>

<p>We eventually settled on using <a href="https://github.com/Masterminds/glide">Glide</a>, and standardized our vendoring process. Glide gave us a reproducible, verifiable <code class="highlighter-rouge">vendor</code> folder for our dependencies, which worked up until we switched to Go modules.</p>

<h2 id="vendoring-using-go-modules">Vendoring using Go modules</h2>

<p>I first heard about Go modules from Russ Cox’s talk at <a href="https://2018.gophercon.sg">GopherCon Singapore</a> in 2018, and soon after started working on adopting modules at Grab, which was to manage our existing <code class="highlighter-rouge">vendor</code> folder.</p>

<p>This allowed us to align with the official Go toolchain and familiarise ourselves with Go modules while the feature matured.</p>

<h3 id="switching-to-go-mod">Switching to go mod</h3>

<p>Go modules introduced a <code class="highlighter-rouge">go mod vendor</code> command for exporting all dependencies from <code class="highlighter-rouge">go.mod</code> into <code class="highlighter-rouge">vendor</code>. We didn’t plan to enable Go modules for builds at this point, so our builds continued to run exactly as before, indifferent to the fact that the vendor directory was created using <code class="highlighter-rouge">go mod</code>.</p>

<p>The initial task to switch to <code class="highlighter-rouge">go mod vendor</code> was relatively straightforward as listed here:</p>

<ol>
  <li>Generated a <code class="highlighter-rouge">go.mod</code> file from our <code class="highlighter-rouge">glide.yaml</code> dependencies. This was scripted so it could be kept up to date without manual effort.</li>
  <li>Replaced the vendor directory.</li>
  <li>Committed the changes.</li>
  <li>Used <code class="highlighter-rouge">go mod</code> instead of glide to manage the vendor folder.</li>
</ol>

<p>The change was extremely large (due to differences in how glide and <code class="highlighter-rouge">go mod</code> handled the pruning of unused code), but equivalent in terms of Go code. However, there were some additional changes needed besides porting the version file.</p>

<h3 id="addressing-incompatible-dependencies">Addressing incompatible dependencies</h3>

<p>Some of our dependencies were not yet compatible with Go modules, so we had to use Go module’s replace directive to substitute them with a working version.</p>

<p>A more complex issue was that parts of our codebase relied on nested vendor directories, and had dependencies that were incompatible with the top level. The <code class="highlighter-rouge">go mod vendor</code> command attempts to include all code nested under the root path, whether or not they have used a sub-vendor directory, so this led to conflicts.</p>

<h4 id="problematic-paths">Problematic paths</h4>

<p>Rather than resolving all the incompatibilities, which would’ve been a major undertaking in the monorepo, we decided to exclude these paths from Go modules instead. This was accomplished by <a href="https://github.com/golang/go/wiki/Modules%23can-an-additional-gomod-exclude-unnecessary-content-do-modules-have-the-equivalent-of-a-gitignore-file">placing an empty go.mod file</a> in the problematic paths.</p>

<h4 id="nested-modules">Nested modules</h4>

<p>The empty <code class="highlighter-rouge">go.mod</code> file worked. This brought us to an important rule of Go modules, which is central to understanding many of the issues we encountered:</p>

<div>
 <p align="middle"><b><i>A module cannot contain other modules</i></b>
</p></div>

<p>This means that although the modules are within the same repository, Go modules treat them as though they are completely independent. When running <code class="highlighter-rouge">go mod</code> commands in the root of the monorepo, Go doesn’t even ‘see’ the other modules nested within.</p>

<h3 id="tackling-maintenance-issues">Tackling maintenance issues</h3>

<p>After completing the initial migration of our vendor directory to go mod vendor however, it opened up a different set of problems related to maintenance.</p>

<p>With Glide, we could guarantee that the Glide files and vendor directory would not change unless we deliberately changed them. This was not the case after switching to Go modules; we found that the <code class="highlighter-rouge">go.mod</code> file frequently required unexpected changes to keep our vendor directory reproducible.</p>

<p>There are two frequent cases that cause the <code class="highlighter-rouge">go.mod</code> file to need updates: <em>dependency inheritance</em> and <em>implicit updates</em>.</p>

<h4 id="dependency-inheritance">Dependency inheritance</h4>

<p>Dependency inheritance is a consequence of Go modules <a href="https://github.com/golang/go/wiki/Modules%23is-gosum-a-lock-file-why-does-gosum-include-information-for-module-versions-i-am-no-longer-using">version selection</a>. If one of the monorepo’s dependencies uses Go modules, then the monorepo inherits those version requirements as well.</p>

<p>When starting a new module, the default is to use the latest version of dependencies. This was an issue for us as some of our monorepo dependencies had not been updated for some time. As engineers wanted to import their module from the monorepo, it caused <code class="highlighter-rouge">go mod vendor</code> to pull in a huge amount of updates.</p>

<p>To solve this issue, we wrote a quick script to copy the dependency versions from one module to another.</p>

<p>One key learning here is to have other modules use the monorepo’s versions, and if any updates are needed then the monorepo should be updated first.</p>

<h4 id="implicit-updates">Implicit updates</h4>

<p>Implicit updates are a more subtle problem. The typical Go modules <a href="https://github.com/golang/go/wiki/Modules%23daily-workflow">workflow</a> is to use standard Go commands: <code class="highlighter-rouge">go build</code>, <code class="highlighter-rouge">go test</code>, and so on, and they will automatically update the <code class="highlighter-rouge">go.mod</code> file as needed. However, this was sometimes surprising, and it wasn’t always clear why the <code class="highlighter-rouge">go.mod</code> file was being updated. Some of the reasons we found were:</p>

<ul>
  <li>A new import was added by mistake, causing the dependency to be added to the <code class="highlighter-rouge">go.mod</code> file</li>
  <li>There is a <a href="https://github.com/golang/go/wiki/Modules%23when-should-i-use-the-replace-directive">local replace</a> for some module B, and B changes its own <code class="highlighter-rouge">go.mod</code>. When there’s a local replace, it bypasses versioning, so the changes to B’s go.mod are immediately inherited.</li>
  <li>The build imports a package from a dependency that can’t be satisfied with the current version, so Go attempts to update it.</li>
</ul>

<p>This means that simply <em>creating</em> a tag in an external repository is sometimes enough to affect the <code class="highlighter-rouge">go.mod</code> file, if you already have a broken import in the codebase.</p>

<h3 id="resolving-unexpected-dependencies-using-graphs">Resolving unexpected dependencies using graphs</h3>

<p>To investigate the unexpected dependencies, the command <code class="highlighter-rouge">go mod graph</code> proved the most useful.</p>

<p>Running <code class="highlighter-rouge">graph</code> with good old grep was good enough, but its output is also compatible with the <a href="https://godoc.org/golang.org/x/tools/cmd/digraph">digraph tool</a> for more sophisticated queries. For example, we could use the following command to trace the source of a dependency on <code class="highlighter-rouge">cloud.google.com/go</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ go mod graph | digraph somepath grab.com/example cloud.google.com/go@v0.26.0

github.com/hashicorp/vault/api@v1.0.4 github.com/hashicorp/vault/sdk@v0.1.13

github.com/hashicorp/vault/sdk@v0.1.13 google.golang.org/genproto@v0.0.0-20190404172233-64821d5d2107

google.golang.org/genproto@v0.0.0-20190404172233-64821d5d2107 google.golang.org/grpc@v1.19.0

google.golang.org/grpc@v1.19.0 cloud.google.com/go@v0.26.0
</code></pre></div></div>

<div class="post-image-section"><figure>
  <img src="/img/go-module-a-guide-for-monorepos-part-1/image1.png" alt="Diagram generated using modgraphviz" />
  <figcaption align="middle"><i>Diagram generated using modgraphviz</i></figcaption>
</figure></div>

<h2 id="stay-tuned-for-more">Stay tuned for more</h2>
<p>I hope you have enjoyed this article. In our next post, we’ll cover the other solutions we have for catching unexpected changes to the <code class="highlighter-rouge">go.mod</code> file and addressing dependency issues.</p>

<h2 id="join-us">Join us</h2>
<p>Grab is more than just the leading ride-hailing and mobile payments platform in Southeast Asia. We use data and technology to improve everything from transportation to payments and financial services across a region of more than 620 million people. We aspire to unlock the true potential of Southeast Asia and look for like-minded individuals to join us on this ride.</p>

<p>If you share our vision of driving South East Asia forward, <a href="https://grab.careers/jobs/">apply</a> to join our team today.</p>

<h4 id="credits">Credits</h4>
<p><em>The cute Go gopher logo for this blog’s cover image was inspired by Renee French’s original work.</em></p>

    </article>
    <div>
      
        <div class="post-tags">
  
  
    <a href="/tags#go" class="label tags-label">Go</a>
  
    <a href="/tags#libraries" class="label tags-label">Libraries</a>
  
    <a href="/tags#monorepo" class="label tags-label">Monorepo</a>
  
    <a href="/tags#vendoring" class="label tags-label">Vendoring</a>
  
    <a href="/tags#vendors" class="label tags-label">Vendors</a>
  
</div>

      
      <br>
    </div>
    <div class="sharing-links text-right">
  Share on &nbsp;
  <a href="https://twitter.com/intent/tweet?text=Go Modules- A guide for monorepos (Part 1)&url=https://engineering.grab.com/go-module-a-guide-for-monorepos-part-1&via=grabengineering&related=grabengineering" class="btn btn-sm btn-share btn-share-twitter" rel="nofollow" target="_new" title="Share on Twitter" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-twitter"></i>&nbsp; Twitter</a>
  <a href="https://facebook.com/sharer.php?u=https://engineering.grab.com/go-module-a-guide-for-monorepos-part-1" class="btn btn-sm btn-share btn-share-facebook" rel="nofollow" target="_new" title="Share on Facebook" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-facebook"></i>&nbsp; Facebook</a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://engineering.grab.com/go-module-a-guide-for-monorepos-part-1&title=Go Modules- A guide for monorepos (Part 1)
&summary=This post is the first in a series of blogs about Grab’s experience with Go modules in a multi-module monorepo. Here, we discuss the challenges we faced along the way and the solutions we came up with.&source=Grab Tech" class="btn btn-sm btn-share btn-share-linkedin" rel="nofollow" target="_new" title="Share on LinkedIn" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-linkedin"></i>&nbsp; LinkedIn</a>
</div>
<script>
  function onShareButtonClick(button) {
    var width = 600;
    var height = 600;
    var left = (window.screen.width / 2) - (width / 2);
    var top = (window.screen.height / 2) - (height / 2);
    window.open(button.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=' + height + ',width=' + width + ',top=' + top + ',left=' + left);
    return false;
  }
</script>

    <hr class="section-divider">
    <div class="panel panel-default hiring-panel">
      <div class="panel-body">
        <div class="row">
          <div class="col-sm-6">
            <h4 class="hiring-tagline">Want to work with us? Grab is hiring!</h4>
          </div>
          <div class="col-sm-6 hiring-btn-container">
            <a class="btn" href="https://grab.careers" target="_blank">View open positions</a>

          </div>
        </div>
      </div>
    </div>
    <br/>
    
      <div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = 'https://engineering.grab.com/go-module-a-guide-for-monorepos-part-1';
    this.page.identifier = '/go-module-a-guide-for-monorepos-part-1';
  };
  (function() {
    var d = document, s = d.createElement('script');
    s.src = '//grabengineering.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    
  </div>
</div>

    </div>
    <footer class="site-footer">
  <div class="wrapper">
    <div class="row">
      <div class="col-sm-6">
        <h2 class="footer-heading">Grab Tech</h2>
        <ul class="social-media-list">
  
    <li>
      <a href="https://github.com/grab" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-github fa-lg"></i>
      </a>
    </li>
  
  
    <li>
      <a href="https://facebook.com/grabengineering" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-facebook-square fa-lg"></i>
      </a>
    </li>
  
  
    <li>
      <a href="https://twitter.com/grabengineering" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-twitter fa-lg"></i>
      </a>
    </li>
  
  
    <li>
      <a href="https://www.linkedin.com/company/grabapp" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-linkedin fa-lg"></i>
      </a>
    </li>
  
  <li>
    <a href="https://engineering.grab.com/feed.xml" target="_blank">
      <i class="fa fa-rss fa-lg"></i>
    </a>
  </li>
</ul>

        <script src="//platform.linkedin.com/in.js" type="text/javascript"> lang: en_US</script>
        <script type="IN/FollowCompany" data-id="5382086" data-counter="right"></script>
      </div>
      <div class="col-sm-6 hiring-section">
        <h2 class="footer-heading">Join Us</h2>
        <p class="text">
          Want to join us in our mission to revolutionize transportation?
        </p>
        <a class="btn" href="https://grab.careers" target="_blank">View open positions</a>

      </div>
    </div>
  </div>
</footer>

    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-73060858-2', 'auto');
    ga('send', 'pageview');
  </script>


  </body>
</html>
