<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>How We Scaled Our Cache and Got a Good Night's Sleep</title>
    <meta name="description" content="Caching is arguably the most important and widely used technique in computer industry, from CPU to Facebook live videos, cache is everywhere.">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Open Graph -->
    <meta property="og:url" content="https://engineering.grab.com/how-we-scaled-our-cache-and-got-a-good-nights-sleep">
    <meta property="og:title" content="How We Scaled Our Cache and Got a Good Night's Sleep">
    <meta property="og:description" content="Caching is arguably the most important and widely used technique in computer industry, from CPU to Facebook live videos, cache is everywhere.">
    <meta property="og:site_name" content="Grab Tech">
    <meta property="og:type" content="article">
    <meta property="og:image" content="https://engineering.grab.com/img/banner.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Favicons -->
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <!-- CSS -->
    <link href="//fonts.googleapis.com/css?family=Droid+Serif:400,400i,700,700i" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://engineering.grab.com/how-we-scaled-our-cache-and-got-a-good-nights-sleep">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS for Official Grab Tech Blog" href="/feed.xml">
</head>

  <body>
    <header class="site-header">
  <div class="wrapper">
    <div class="site-title-wrapper">
      <div class="row site-title-wrapper-inner">
        <div class="col-sm-8 col-xs-4">
          <div>
            <a class="site-title" href="/"></a>
            <span class="site-subtitle hidden-xs">&nbsp;Tech Blog</span>
          </div>
        </div>
        <div class="col-sm-4 col-xs-8 text-right site-search">
          <form action="/search.html" method="get">
  <div class="input-group">
    <input type="text" id="search" name="q" class="form-control" placeholder="Search...">
    <span class="input-group-btn">
      <button class="btn" type="submit"><i class="fa fa-search"></i></button>
    </span>
  </div>
</form>

        </div>
      </div>
    </div>
    <nav>
      <ul class="nav-category">
        
          
          <li>
            <a href="/categories/engineering/">Engineering</a>
          </li>
        
          
          <li>
            <a href="/categories/data-science/">Data Science</a>
          </li>
        
          
          <li>
            <a href="/categories/design/">Design</a>
          </li>
        
          
          <li>
            <a href="/categories/product/">Product</a>
          </li>
        
          
          <li>
            <a href="/categories/security/">Security</a>
          </li>
        
      </ul>
    </nav>
  </div>
</header>

    <div class="page-content">
      
<div class="wrapper">
  <div class="post">
    <header class="post-header">
      <div class="text-center">
        
          
            
            
              <img class="post-author-thumbnail-large img-circle" src="/img/authors/gao-chao.jpg">
            
          
        
      </div>
      <br>
      <h1 class="post-title text-center">How We Scaled Our Cache and Got a Good Night's Sleep</h1>
      
      <div class="post-meta">
        19 Jun 2017
        
          
            
            
              &middot;
              <a href="/authors#gao-chao">Gao Chao</a>
            
          
        
        
        
          <div class="post-tags">
  
  
    <a href="/tags#back-end" class="label tags-label">Back End</a>
  
    <a href="/tags#redis" class="label tags-label">Redis</a>
  
</div>

        
      </div>
    </header>
    <article class="post-content">
      <p>Caching is arguably the most important and widely used technique in computer industry, from CPU to Facebook live videos, cache is everywhere.</p>

<h3 id="problem">Problem</h3>

<p>Our CDS (Common Data Service) relies heavily on caching too. It helps us reduce database load and generate faster responses to our consumers. But as our business grows, the load on our cache system grows too and it might eventually become a bottleneck.</p>

<p>To solve this potential problem, we need to be able to horizontally scale our cache system. Why horizontally?</p>

<ol>
  <li>We want to have more caching space in order to accommodate more caches in future.</li>
  <li>The caching system we are using is single-threaded (<strong>Redis provided by ElasticCache</strong>) which would only use one core even in a multicore system. Vertically scaling by adding more cores to one machine simply doesn’t help.</li>
</ol>

<p>The options available to us are as follow:</p>

<ol>
  <li>Use Redis master-slave model and make all writes go through master, all reads through multiple slaves.</li>
  <li>Use Twemproxy as a middle layer of distributing caches to multiple backend ElasticCache machines.</li>
  <li>Custom sharding the cache keys across multiple ElasticCache machines.</li>
</ol>

<p>There are a few known drawbacks of the first approach, especially when there is some trickiness that comes with replication and master fail-over scenarios, as described in <a href="/a-key-expired-in-redis-you-wont-believe-what-happened-next">this post</a>.</p>

<p>Moreover, the first approach doesn’t solve our first problem - to have more memory space in order to accommodate more caches. Naturally, we gave it up.</p>

<p>The second approach of using Twemproxy isn’t a good solution either. It has been proven before that under a heavy load, Twemproxy will become the bottleneck as all the cache I/O will be going through there.</p>

<h3 id="design">Design</h3>

<p>Finally, we decided to implement a custom sharding mechanism for our caches. Each CDS instance will hash each of the keys it needs to read or write, and based on the hashed value it will figure out which shard the key is possibly in and then access that shard for the interested key. This approach is essentially what Twemproxy does to CDS instances, thus distributing the load.</p>

<h4 id="twemproxy">Twemproxy</h4>

<div class="post-image-section">
  <img alt="Twemproxy Hashing" src="/img/how-we-scaled-our-cache-and-got-a-good-nights-sleep/twemproxy.png" />
</div>

<h4 id="cds-hashing">CDS Hashing</h4>

<div class="post-image-section">
  <img alt="CDS Hashing" src="/img/how-we-scaled-our-cache-and-got-a-good-nights-sleep/cds-hashing.png" />
</div>

<p>We wrote an internal Golang package to implement consistent hashing already and we have a fairly clean abstraction, so the work becomes pretty easy - wrap the components!</p>

<h3 id="implementation">Implementation</h3>

<p>Coming to the topic of implementation, the first thing we considered is that even though the logic of cache read / write is different in this sharding model, it’s still a cache from our server’s point of view. So we added an interface called <code class="highlighter-rouge">ShardedCache</code> which is composited with the original <code class="highlighter-rouge">Cache</code> interface (so it has the same exposed methods with <code class="highlighter-rouge">Cache</code>) that allows us to easily swap implementations where cache is used.</p>

<p>The second thing we made sure of is that <code class="highlighter-rouge">ShardedCache</code> is only a thin wrapper on top of <code class="highlighter-rouge">Cache</code>. The core caching I/O features still happens in <code class="highlighter-rouge">Cache</code> implementation and what <code class="highlighter-rouge">ShardedCache</code> provides is hashing capability so it will be much easier for these 2 implementations evolve in parallel with minimum impact on each other.</p>

<p>Furthermore, although we are using ketama as default hashing method, users can still inject their own hashing functions if needed. This facilitates tests and future extensions.</p>

<h3 id="deployment">Deployment</h3>

<p>Shipping a new software to production always comes with risk. Especially with such a critical system as caching.</p>

<p>When switching to a new cache mechanism, some cache misses are inevitable, so we chose to deploy during the relatively peaceful hours at night, so that we can have some cache warm up time before the morning peak.</p>

<p>Also, we have a cron job to populate caches for some heavy requests every 12 hours, so we need to make the cron job double write cache to the new systems beforehand in order to prevent high volume DB reads and possible data inconsistencies.</p>

<p>Therefore, the steps are:</p>

<ol>
  <li>Configure cron job double writing to the new cache system – Need to deploy CDS because cron job is running within CDS.</li>
  <li>Verify the populated caches in new system and configure CDS to read from there – Need to deploy CDS again for the configuration changes.</li>
</ol>

<p>This process took 2 days to finish, a little tedious but worth doing for a max degree of reliability.</p>

<h3 id="outcome">Outcome</h3>

<p>With everything is in place, we deployed it and here’s what happened:</p>

<p>As you can see from the graphs below, although we are experiencing more load, after a period of warmup. The sharded caching solution offers much better P99 latency comparing to the old single system.</p>

<div class="post-image-section">
  <img alt="Sharded Caching Redis" src="/img/how-we-scaled-our-cache-and-got-a-good-nights-sleep/cache-1.png" />
</div>

<div class="post-image-section">
  <img alt="Redis Usage - Day by Day" src="/img/how-we-scaled-our-cache-and-got-a-good-nights-sleep/cache-2.png" />
</div>

<p><em>Many thanks to Jason Xu for his awesome consistent hashing package and Nguyen Qui Hieu for his discussion of this solution and help in setting up new ElasticCache nodes.</em></p>

<p><em>P.S. If you or your friends are interested in the work we are doing in Engineering Data and want to explore more, you are welcome to <a href="https://grab.careers/">talk to us</a>! We are eagerly looking for good engineers to grow our team!</em></p>

<h3 id="references">References</h3>

<ul>
  <li><a href="https://en.wikipedia.org/wiki/Consistent_hashing">Consistent Hashing</a></li>
</ul>

    </article>
    <div>
      
        <div class="post-tags">
  
  
    <a href="/tags#back-end" class="label tags-label">Back End</a>
  
    <a href="/tags#redis" class="label tags-label">Redis</a>
  
</div>

      
      <br>
    </div>
    <div class="sharing-links text-right">
  Share on &nbsp;
  <a href="https://twitter.com/intent/tweet?text=How We Scaled Our Cache and Got a Good Night's Sleep&url=https://engineering.grab.com/how-we-scaled-our-cache-and-got-a-good-nights-sleep&via=grabengineering&related=grabengineering" class="btn btn-sm btn-share btn-share-twitter" rel="nofollow" target="_new" title="Share on Twitter" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-twitter"></i>&nbsp; Twitter</a>
  <a href="https://facebook.com/sharer.php?u=https://engineering.grab.com/how-we-scaled-our-cache-and-got-a-good-nights-sleep" class="btn btn-sm btn-share btn-share-facebook" rel="nofollow" target="_new" title="Share on Facebook" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-facebook"></i>&nbsp; Facebook</a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://engineering.grab.com/how-we-scaled-our-cache-and-got-a-good-nights-sleep&title=How We Scaled Our Cache and Got a Good Night's Sleep
&summary=Caching is arguably the most important and widely used technique in computer industry, from CPU to Facebook live videos, cache is everywhere.&source=Grab Tech" class="btn btn-sm btn-share btn-share-linkedin" rel="nofollow" target="_new" title="Share on LinkedIn" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-linkedin"></i>&nbsp; LinkedIn</a>
</div>
<script>
  function onShareButtonClick(button) {
    var width = 600;
    var height = 600;
    var left = (window.screen.width / 2) - (width / 2);
    var top = (window.screen.height / 2) - (height / 2);
    window.open(button.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=' + height + ',width=' + width + ',top=' + top + ',left=' + left);
    return false;
  }
</script>

    <hr class="section-divider">
    <div class="panel panel-default hiring-panel">
      <div class="panel-body">
        <div class="row">
          <div class="col-sm-6">
            <h4 class="hiring-tagline">Want to work with us? Grab is hiring!</h4>
          </div>
          <div class="col-sm-6 hiring-btn-container">
            <a class="btn" href="https://grab.careers" target="_blank">View open positions</a>

          </div>
        </div>
      </div>
    </div>
    <br/>
    
      <div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = 'https://engineering.grab.com/how-we-scaled-our-cache-and-got-a-good-nights-sleep';
    this.page.identifier = '/how-we-scaled-our-cache-and-got-a-good-nights-sleep';
  };
  (function() {
    var d = document, s = d.createElement('script');
    s.src = '//grabengineering.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    
  </div>
</div>

    </div>
    <footer class="site-footer">
  <div class="wrapper">
    <div class="row">
      <div class="col-sm-6">
        <h2 class="footer-heading">Grab Tech</h2>
        <ul class="social-media-list">
  
    <li>
      <a href="https://github.com/grab" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-github fa-lg"></i>
      </a>
    </li>
  
  
    <li>
      <a href="https://facebook.com/grabengineering" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-facebook-square fa-lg"></i>
      </a>
    </li>
  
  
    <li>
      <a href="https://twitter.com/grabengineering" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-twitter fa-lg"></i>
      </a>
    </li>
  
  
    <li>
      <a href="https://www.linkedin.com/company/grabapp" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-linkedin fa-lg"></i>
      </a>
    </li>
  
  <li>
    <a href="https://engineering.grab.com/feed.xml" target="_blank">
      <i class="fa fa-rss fa-lg"></i>
    </a>
  </li>
</ul>

        <script src="//platform.linkedin.com/in.js" type="text/javascript"> lang: en_US</script>
        <script type="IN/FollowCompany" data-id="5382086" data-counter="right"></script>
      </div>
      <div class="col-sm-6 hiring-section">
        <h2 class="footer-heading">Join Us</h2>
        <p class="text">
          Want to join us in our mission to revolutionize transportation?
        </p>
        <a class="btn" href="https://grab.careers" target="_blank">View open positions</a>

      </div>
    </div>
  </div>
</footer>

    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-73060858-2', 'auto');
    ga('send', 'pageview');
  </script>


  </body>
</html>
