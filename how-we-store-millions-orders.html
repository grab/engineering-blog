<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>How we store and process millions of orders daily</title>
    <meta name="description" content="The Grab Order Platform is a distributed system that processes millions of GrabFood or GrabMart orders every day.  Learn about how the Grab order platform stores food order data to serve transactional (OLTP) and analytical (OLAP) queries.">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Open Graph -->
    <meta property="og:url" content="https://engineering.grab.com/how-we-store-millions-orders">
    <meta property="og:title" content="How we store and process millions of orders daily">
    <meta property="og:description" content="The Grab Order Platform is a distributed system that processes millions of GrabFood or GrabMart orders every day.  Learn about how the Grab order platform stores food order data to serve transactional (OLTP) and analytical (OLAP) queries.">
    <meta property="og:site_name" content="Grab Tech">
    <meta property="og:type" content="article">
    <meta property="og:image" content="https://engineering.grab.com/img/how-we-store-millions-orders/splash.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Favicons -->
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <!-- CSS -->
    <link href="//fonts.googleapis.com/css?family=Droid+Serif:400,400i,700,700i" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://engineering.grab.com/how-we-store-millions-orders">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS for Official Grab Tech Blog" href="/feed.xml">
</head>

  <body>
    <header class="site-header">
  <div class="wrapper-navbar">
    <div class="site-title-wrapper">
      <div class="row site-title-wrapper-inner">
        <div class="col-xs-1 visible-xs hamburger-nav" id="mobile-menu-btn">
          <div class="menu-btn"></div>
        </div>
        <div class="col-sm-3 col-xs-3">
          <div class="site-title-container">
            <a class="site-title" href="/"></a>
            <span class="site-subtitle">&nbsp;Tech Blog</span>
          </div>
        </div>
        <div class="col-sm-9 col-xs-8 text-right">
          <ul class="nav-category hidden-xs">
            
              
              <li>
                <a href="/categories/engineering/">Engineering</a>
              </li>
            
              
              <li>
                <a href="/categories/data-science/">Data Science</a>
              </li>
            
              
              <li>
                <a href="/categories/design/">Design</a>
              </li>
            
              
              <li>
                <a href="/categories/product/">Product</a>
              </li>
            
              
              <li>
                <a href="/categories/security/">Security</a>
              </li>
            
          </ul>
          <div class="site-search text-right">
            <form action="/search.html" role="search" class="search-form">
  <div class="search-icon"> </div>
  <input type="search" name="q" class="search-text" placeholder="Search...">
  <button class="search-submit"><i class="fa fa-chevron-right"></i></button>
</form>
    

          </div>
        </div>
      </div>
      <!--  Only visible on mobile view -->
      <div class="mobile-menu-container">
        <ul class="mobile-menu">
          
            
            <li>
              <a href="/categories/engineering/">Engineering</a>
            </li>
          
            
            <li>
              <a href="/categories/data-science/">Data Science</a>
            </li>
          
            
            <li>
              <a href="/categories/design/">Design</a>
            </li>
          
            
            <li>
              <a href="/categories/product/">Product</a>
            </li>
          
            
            <li>
              <a href="/categories/security/">Security</a>
            </li>
          
        </ul>
      </div>
    </div>
  </div>
</header>
<script src="/js/main.js"></script>

    <div class="page-content">
      
<div class="wrapper">
  <div class="post">
    <header class="post-header">
      <img src="/img/how-we-store-millions-orders/splash.jpg" class="post-cover-photo" alt="How we store and process millions of orders daily cover photo">
      
        
          <a class="post-category" href="/categories/engineering/">Engineering </a>
      
        
          &middot;
        
          <a class="post-category" href="/categories/data-science/">Data Science </a>
      

      <h1 class="post-title">How we store and process millions of orders daily</h1>
      
      <div class="post-meta">
        <div class="row">
          <div class="col-xs-12">
            <div class="post-author-thumbnail-container">
              
                
                
                  <img class="post-author-thumbnail-large img-circle" src="/img/authors/xi-chen.jpg">
                
              
                
                
                  <img class="post-author-thumbnail-large img-circle" src="/img/authors/siliang-cao.jpg">
                
              
            </div>

            <div class="post-meta-text-container">
              <span class="post-author-large">
                
                  
                  
                    
                    <a href="/authors#xi-chen">Xi Chen</a>
                  
                
                  
                  
                    
                      &middot;
                    
                    <a href="/authors#siliang-cao">Siliang Cao</a>
                  
                
              </span>
              <span class="post-date-large">11 Aug 2022 | 9 min read</span>
            </div>
          </div>
        </div>
      </div>

    </header>
    <div class="wrapper-content">
      <article class="post-content">
        <h1 id="introduction">Introduction</h1>

<p>In the real world, after a passenger places a GrabFood order from the Grab App, the merchant-partner will prepare the order. A driver-partner will then collect the food and deliver it to the passenger. Have you ever wondered what happens in the backend system? The Grab Order Platform is a distributed system that processes millions of GrabFood or GrabMart orders every day. This post aims to share the journey of how we designed the database solution that powers the order platform.</p>

<h1 id="background">Background</h1>

<p>What are the design goals when building the database solution? We collected the requirements by analysing query patterns and traffic patterns.</p>

<h3 id="query-patterns">Query patterns</h3>

<p>Here are some important query examples that the order platform supports:</p>

<ol>
  <li>
    <p>Write queries:</p>

    <p>a.  Create an order.</p>

    <p>b.  Update an order.</p>
  </li>
  <li>
    <p>Read queries:</p>

    <p>a.  Get order by id.</p>

    <p>b.  Get ongoing orders by passenger id.</p>

    <p>c.  Get historical orders by various conditions.</p>

    <p>d.  Get order statistics (for example, get the number of orders)</p>
  </li>
</ol>

<p>We can break down queries into two categories; transactional queries and analytical queries. Transactional queries are very critical to online order creation and completion, including the write queries and read queries such as 2a or 2b. Analytical queries like 2c and 2d retrieves historical orders or order statistics on demand. Analytical queries are not critical to the oncall order processing.</p>

<h3 id="traffic-patterns">Traffic patterns</h3>

<p>Grab Order Platform processes a significant amount of transaction data every month.</p>

<p>During peak hours, the write Queries per Second is 3 times of primary key reads; whilst the range Queries per Second are 4 times of the primary key reads.</p>

<h3 id="design-goals">Design goals</h3>

<p>From the query and traffic patterns, we arrived at the following three design goals:</p>

<ol>
  <li><strong>Stability</strong> - the database solution must be able to handle high read and write QPS. Online order processing queries must have high availability. Even when some part of the system is down, we must be able to provide a degraded experience to the end users allowing them to still be able to create and complete an order.</li>
  <li><strong>Scalability and cost</strong> - the database solution must be able to support fast evolution of business requirements, given now we already have million orders per month. The solution must also be cost effective at a large scale.</li>
  <li><strong>Consistency</strong> - strong consistency for transactional queries, and eventually consistency for analytical queries.</li>
</ol>

<h1 id="solution">Solution</h1>

<p>The first design principle towards a stable and scalable database solution is to use different databases to serve transactional and analytical queries, also known as OLTP and OLAP queries. An OLTP database serves queries critical to online order processing. This table keeps data for only a short period of time. Meanwhile, an OLAP database has the same set of data, but serves our historical and statistical queries. This database keeps data for a longer time.</p>

<p>What are the benefits from this design principle? From a stability point of view, we can choose different databases which can better fulfil our different query patterns and QPS requirements. An OLTP database is the single source of truth for online order processing; any failure in the OLAP database will not affect online transactions. From a scalability and cost point of view, we can choose a flexible database for OLAP to support our fast evolution of business requirements. We can maintain less data in our OLTP database while keeping some older data in our OLAP database.</p>

<p>To ensure that the data in both databases are consistent, we introduced the second design principle - data ingestion pipeline. In Figure 1, Order Platform writes data to the OLTP database to process online orders and asynchronously pushes the data into the data ingestion pipeline. The data ingestion pipeline ensures that the OLAP database data is eventually consistent.</p>

<div class="post-image-section">
  <img alt="Order Platform database solution overview" src="/img/how-we-store-millions-orders/image3.png" />
  <small class="post-image-caption">Figure 1: Order Platform database solution overview</small>
</div>
<p>&nbsp;</p>

<h2 id="architecture-details">Architecture details</h2>

<h3 id="oltp-database">OLTP database</h3>

<p>There are two categories of OLTP queries, the key-value queries (for example, load by order id) and the batch queries (for example, Get ongoing orders by passenger id). We use DynamoDB as the database to support these OLTP queries.</p>

<p>Why DynamoDB?</p>

<ol>
  <li>Scalable and highly available: the tables of DynamoDB are partitioned and each partition is three-way replicated.</li>
  <li>DynamoDB supports strong consistent reads by primary key.</li>
  <li>DynamoDB has a mechanism called adaptive capacity to handle hotkey traffic. Internally, DynamoDB will distribute higher capacity to high-traffic partitions, and isolate the frequently accessed items to a dedicated partition. In this way, the hotkey can utilise the full capacity of an entire partition; up to 3000 read capacity units and 1000 write capacity units.</li>
</ol>

<div class="post-image-section">
  <img alt="DynamoDB table structure overview" src="/img/how-we-store-millions-orders/image2.png" />
  <small class="post-image-caption">Figure 2: DynamoDB table structure overview. Source:  <a href="#aws">Amazon Web Services (2019, 28 April)</a></small>
</div>
<p>&nbsp;</p>

<p>In each DynamoDB table, it has many items with attributes. In each item, it has a partition key and sort key. The partition key is used for key-value queries, and the sort key is used for range queries. In our case, the table contains multiple order items. The partition key is order ID. We can easily support key-value queries by the partition key.</p>

<table class="table">
  <thead>
    <tr>
      <th>order_id (PK)</th>
      <th>state</th>
      <th>pax_id</th>
      <th>created_at</th>
      <th>pax_id_gsi</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>order1</td>
      <td>Ongoing</td>
      <td>Alice</td>
      <td>9:00am</td>
    </tr>
    <tr>
      <td>order2</td>
      <td>Ongoing</td>
      <td>Alice</td>
      <td>9:30am</td>
    </tr>
    <tr>
      <td>order3</td>
      <td>Completed</td>
      <td>Alice</td>
      <td>8:30am</td>
    </tr>
  </tbody>
</table>

<p>Batch queries like ‘Get ongoing orders by passenger id’ are supported by DynamoDB Global Secondary Index (GSI). A GSI is like a normal DynamoDB table, which also has keys and attributes.</p>

<p>In our case, we have a GSI table where the partition key is the <code class="language-plaintext highlighter-rouge">pax_id_gsi</code>. The attribute <code class="language-plaintext highlighter-rouge">pax_id_gsi</code> is linked to the main table. It is eventually consistent with the main table that is maintained by DynamoDB. If the Order Platform queries ongoing orders for Alice, 2 items will be returned from the GSI table.</p>

<table class="table">
  <thead>
    <tr>
      <th>pax_id_gsi (PK)</th>
      <th>created_at (SK)</th>
      <th>order_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Alice</td>
      <td>9:00am</td>
      <td>order1</td>
    </tr>
    <tr>
      <td>Alice</td>
      <td>9:30am</td>
      <td>order2</td>
    </tr>
  </tbody>
</table>

<p>We also make use of an advanced feature of GSI named sparse index to support ongoing order queries. When we update order status from ongoing to completed, at the same time, we set the <code class="language-plaintext highlighter-rouge">pax_id_gsi</code> to empty, so that the linked item in the GSI will be automatically deleted by DynamoDB. At any time, the GSI table only stores the ongoing orders. We use a sparse index mechanism to control our table size for better performance and to be more cost effective.</p>

<p>The next problem is data retention. This is achieved with the DynamoDB Time To Live (TTL) feature. DynamoDB will auto-scan expired items and delete them. But there is a challenge that when we add TTL on big tables, it will bring a heavy load to the background scanner and might result in an outage. Our solution is to just add a TTL attribute to the new items in the table. Then, we manually delete the items without TTL attributes, and delete items having TTL attributes that are too old by using a script. After that, the table size will be quite small, so we enable the TTL feature on the TTL attribute that we previously added without any concern. The retention period of our DynamoDB data is three months.</p>

<p>Costwise, DynamoDB is charged by storage size and the provision of the read write capability. The provision capability is actually auto scalable. The cost is on-demand. So it’s generally cheaper than RDS.</p>

<h3 id="olap-database">OLAP database</h3>

<p>We use MySQL RDS as the database to support historical and statistical OLAP queries.</p>

<p>Why not Aurora? We choose RDS mainly because it is a mature database solution. Even if Aurora can provide better high-availability, RDS is enough to support our less critical use cases. Costwise, Aurora charges by data storage and the number of requested Input/Output Operations per Second (IOPS). RDS charges only by data storage. As we are using General Purpose (SSD) storage, IOPS is free and supports up to 16k IOPS.</p>

<p>We use MySQL partitioning for data retention. The order table is partitioned by creation time monthly. Since the data access pattern is mostly by month, the partition key can reduce cross-partition queries. Partitions older than six months are dropped at the beginning of each month.</p>

<h3 id="data-ingestion-pipeline">Data ingestion pipeline</h3>

<div class="post-image-section">
  <img alt="DynamoDB table structure overview" src="/img/how-we-store-millions-orders/image1.png" />
  <small class="post-image-caption">Figure 3: Data Ingestion Pipeline Architecture. &lt;/a&gt;</small>
</div>
<p>&nbsp;</p>

<p>A Kafka stream is used to process data in the data ingestion pipeline. We choose the Kafka stream, because it has 99.95% SLA. It is not restricted by the OLTP and OLAP database types.</p>

<p>Even if Kafka can provide 99.95% SLA, there is still the chance of stream producer failures. When the producer fails, we will store the message in an Amazon Simple Queue Service (SQS) and retry. If the retry also fails, it will be moved to the SQS dead letter queue (DLQ), to be consumed at a later time.</p>

<p>On the stream consumer side, we use back-off retry at both stream and database levels to ensure consistency. In a worst-case scenario, we can rewind the stream events from Kafka.</p>

<p>It is important for the data ingestion pipeline to handle duplicate messages and out-of-order messages.</p>

<p>Duplicate messages are handled by the database level unique key (for example, order ID + creation time).</p>

<p>For the out-of-order messages, we implemented the following two mechanisms:</p>

<ol>
  <li>Version update: we only update the most recently updated data. The precision of the update time is in microseconds, which is enough for most of the use cases.</li>
  <li>Upsert: if the update events occur before the create events, we simulate an upsert operation.</li>
</ol>

<h2 id="impact">Impact</h2>

<p>After launching our solution this year, we have saved significantly on cloud costs. In the earlier solution, Order Platform synchronously writes to DynamoDB and Aurora and the data is kept forever.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Stability wise, we use DynamoDB as the critical OLTP database to ensure high availability for online order processing. Scalability wise, we use RDS as the OLAP database to support our quickly evolving business requirements by using a rich, multiple index. Cost efficiency is achieved by data retention in both databases. For consistency, we built a single source of truth OLTP database and an OLAP database that is eventually consistent with the help of the data ingestion pipeline.</p>

<h1 id="whats-next">What’s next</h1>

<p>Currently, the database solution is running on the production environment. Even though the database solution is proven to be stable, scalable and consistent, we still see some potential areas of improvement.</p>

<p>We use MySQL RDS for OLAP data storage. Even though MySQL is stable and cost effective, it is difficult to serve more complicated queries like free text search. Hence, we plan to explore other NoSQL databases like ElasticSearch.</p>

<p>We hope this post helps you understand how we store Grab orders and fulfil the queries from the Grab Order Platform.</p>

<h1 id="references">References</h1>

<!-- Figure 2, DynamoDB overview is taken from [Getting Started with Amazon DynamoDB](https://www.slideshare.net/AmazonWebServices/getting-started-with-amazon-dynamodb-63948367), authored by Amazon Web Services. -->

<p><a id="aws"></a>Amazon Web Services. (2019, 28 April) <em>Build with DynamoDB: S1 E1 – Intro to Amazon DynamoDB</em> [Video]. YouTube. <a href="https://youtu.be/W3S1OnDqWl4?t=455">https://youtu.be/W3S1OnDqWl4?t=455</a>.</p>

<h1 id="join-us">Join us</h1>
<p>Grab is the leading superapp platform in Southeast Asia, providing everyday services that matter to consumers. More than just a ride-hailing and food delivery app, Grab offers a wide range of on-demand services in the region, including mobility, food, package and grocery delivery services, mobile payments, and financial services across 428 cities in eight countries.</p>

<p>Powered by technology and driven by heart, our mission is to drive Southeast Asia forward by creating economic empowerment for everyone. If this mission speaks to you, <a href="https://grab.careers/">join our team</a> today!</p>

      </article>
      <div>
        
          <div class="post-tags">
  
  
    <a href="/tags#database" class="label tags-label">Database</a>
  
    <a href="/tags#distributed-systems" class="label tags-label">Distributed Systems</a>
  
    <a href="/tags#platform" class="label tags-label">Platform</a>
  
    <a href="/tags#storage" class="label tags-label">Storage</a>
  
</div>

        
        <br>
      </div>
      <div class="sharing-links text-right">
  Share on &nbsp;
  <a href="https://twitter.com/intent/tweet?text=How we store and process millions of orders daily&url=https://engineering.grab.com/how-we-store-millions-orders&via=grabengineering&related=grabengineering" class="btn btn-sm btn-share btn-share-twitter" rel="nofollow" target="_new" title="Share on Twitter" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-twitter"></i>&nbsp; Twitter</a>
  <a href="https://facebook.com/sharer.php?u=https://engineering.grab.com/how-we-store-millions-orders" class="btn btn-sm btn-share btn-share-facebook" rel="nofollow" target="_new" title="Share on Facebook" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-facebook"></i>&nbsp; Facebook</a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://engineering.grab.com/how-we-store-millions-orders&title=How we store and process millions of orders daily
&summary=The Grab Order Platform is a distributed system that processes millions of GrabFood or GrabMart orders every day.  Learn about how the Grab order platform stores food order data to serve transactional (OLTP) and analytical (OLAP) queries.&source=Grab Tech" class="btn btn-sm btn-share btn-share-linkedin" rel="nofollow" target="_new" title="Share on LinkedIn" onclick="onShareButtonClick(this); return false;"><i class="fa fa-lg fa-linkedin"></i>&nbsp; LinkedIn</a>
</div>
<script>
  function onShareButtonClick(button) {
    var width = 600;
    var height = 600;
    var left = (window.screen.width / 2) - (width / 2);
    var top = (window.screen.height / 2) - (height / 2);
    window.open(button.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=' + height + ',width=' + width + ',top=' + top + ',left=' + left);
    return false;
  }
</script>

      <hr class="section-divider">

      <br/>
      <!-- 
        <div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = 'https://engineering.grab.com/how-we-store-millions-orders';
    this.page.identifier = '/how-we-store-millions-orders';
  };
  (function() {
    var d = document, s = d.createElement('script');
    s.src = '//grabengineering.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

       -->

    </div>
  </div>
</div>

    </div>
    <div class="progress-wrap">
    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98" />
    </svg>
    <i class="fa fa-chevron-up btt-btn"></i>
</div>
    <footer class="site-footer">
  <div class="wrapper">
    <div class="row">
      <div class="col-sm-6 col-xs-12">
        <h2 class="footer-heading">Grab Tech</h2>
        <ul class="social-media-list">
  
    <li>
      <a href="https://github.com/grab" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-github fa-lg"></i>
      </a>
    </li>
  
  
    <li>
      <a href="https://www.linkedin.com/company/grabapp" target="_blank" rel="nofollow noreferrer">
        <i class="fa fa-linkedin fa-lg"></i>
      </a>
    </li>
  
  <li>
    <a href="https://engineering.grab.com/feed.xml" target="_blank">
      <i class="fa fa-rss fa-lg"></i>
    </a>
  </li>
</ul>

        <div>
          <script src="//platform.linkedin.com/in.js" type="text/javascript"> lang: en_US</script>
          <script type="IN/FollowCompany" data-id="5382086" data-counter="right"></script>
        </div>        
        <br>
      </div>
      <div class="col-sm-6 col-xs-12 hiring-section">
        <h2 class="footer-heading">Join Us</h2>
        <p class="text">
          Want to join us in our mission to revolutionize transportation?
        </p>
        <a class="btn" href="https://grab.careers" target="_blank">View open positions</a>

      </div>
    </div>
    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-73060858-2', 'auto');
    ga('send', 'pageview');
  </script>


  </body>
</html>
